"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const core_1 = require("@angular-devkit/core");
const node_1 = require("@angular-devkit/core/node");
const path = require("path");
const read_tsconfig_1 = require("../angular-cli-files/utilities/read-tsconfig");
const utils_1 = require("../utils");
const SpeedMeasurePlugin = require('speed-measure-webpack-plugin');
const webpackMerge = require('webpack-merge');
async function generateWebpackConfig(workspaceRoot, projectRoot, sourceRoot, options, webpackPartialGenerator, logger) {
    // Ensure Build Optimizer is only used with AOT.
    if (options.buildOptimizer && !options.aot) {
        throw new Error(`The 'buildOptimizer' option cannot be used without 'aot'.`);
    }
    const tsConfigPath = path.resolve(workspaceRoot, options.tsConfig);
    const tsConfig = read_tsconfig_1.readTsconfig(tsConfigPath);
    // tslint:disable-next-line:no-implicit-dependencies
    const projectTs = await Promise.resolve().then(() => require('typescript'));
    const supportES2015 = tsConfig.options.target !== projectTs.ScriptTarget.ES3
        && tsConfig.options.target !== projectTs.ScriptTarget.ES5;
    const wco = {
        root: workspaceRoot,
        logger: logger.createChild('webpackConfigOptions'),
        projectRoot,
        sourceRoot,
        buildOptions: options,
        tsConfig,
        tsConfigPath,
        supportES2015,
    };
    wco.buildOptions.progress = utils_1.defaultProgress(wco.buildOptions.progress);
    const partials = webpackPartialGenerator(wco);
    const webpackConfig = webpackMerge(partials);
    if (options.profile || process.env['NG_BUILD_PROFILING']) {
        const smp = new SpeedMeasurePlugin({
            outputFormat: 'json',
            outputTarget: path.resolve(workspaceRoot, 'speed-measure-plugin.json'),
        });
        return smp.wrap(webpackConfig);
    }
    return webpackConfig;
}
exports.generateWebpackConfig = generateWebpackConfig;
async function generateBrowserWebpackConfigFromWorkspace(options, projectName, workspace, host, webpackPartialGenerator, logger) {
    // TODO: Use a better interface for workspace access.
    const projectRoot = core_1.resolve(workspace.root, core_1.normalize(workspace.getProject(projectName).root));
    const projectSourceRoot = workspace.getProject(projectName).sourceRoot;
    const sourceRoot = projectSourceRoot
        ? core_1.resolve(workspace.root, core_1.normalize(projectSourceRoot))
        : undefined;
    const normalizedOptions = utils_1.normalizeBrowserSchema(host, workspace.root, projectRoot, sourceRoot, options);
    return generateWebpackConfig(core_1.getSystemPath(workspace.root), core_1.getSystemPath(projectRoot), sourceRoot && core_1.getSystemPath(sourceRoot), normalizedOptions, webpackPartialGenerator, logger);
}
exports.generateBrowserWebpackConfigFromWorkspace = generateBrowserWebpackConfigFromWorkspace;
async function generateBrowserWebpackConfigFromContext(options, context, webpackPartialGenerator, host = new node_1.NodeJsSyncHost()) {
    const registry = new core_1.schema.CoreSchemaRegistry();
    registry.addPostTransform(core_1.schema.transforms.addUndefinedDefaults);
    const workspace = await core_1.experimental.workspace.Workspace.fromPath(host, core_1.normalize(context.workspaceRoot), registry);
    const projectName = context.target ? context.target.project : workspace.getDefaultProjectName();
    if (!projectName) {
        throw new Error('Must either have a target from the context or a default project.');
    }
    const config = await generateBrowserWebpackConfigFromWorkspace(options, projectName, workspace, host, webpackPartialGenerator, context.logger);
    return { workspace, config };
}
exports.generateBrowserWebpackConfigFromContext = generateBrowserWebpackConfigFromContext;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2VicGFjay1icm93c2VyLWNvbmZpZy5qcyIsInNvdXJjZVJvb3QiOiIuLyIsInNvdXJjZXMiOlsicGFja2FnZXMvYW5ndWxhcl9kZXZraXQvYnVpbGRfYW5ndWxhci9zcmMvdXRpbHMvd2VicGFjay1icm93c2VyLWNvbmZpZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQVFBLCtDQVE4QjtBQUM5QixvREFBMkQ7QUFFM0QsNkJBQTZCO0FBRzdCLGdGQUE0RTtBQUU1RSxvQ0FBbUc7QUFFbkcsTUFBTSxrQkFBa0IsR0FBRyxPQUFPLENBQUMsOEJBQThCLENBQUMsQ0FBQztBQUNuRSxNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUM7QUFJdkMsS0FBSyxVQUFVLHFCQUFxQixDQUN6QyxhQUFxQixFQUNyQixXQUFtQixFQUNuQixVQUE4QixFQUM5QixPQUF1QyxFQUN2Qyx1QkFBc0YsRUFDdEYsTUFBeUI7SUFFekIsZ0RBQWdEO0lBQ2hELElBQUksT0FBTyxDQUFDLGNBQWMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUU7UUFDMUMsTUFBTSxJQUFJLEtBQUssQ0FBQywyREFBMkQsQ0FBQyxDQUFDO0tBQzlFO0lBRUQsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxhQUFhLEVBQUUsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ25FLE1BQU0sUUFBUSxHQUFHLDRCQUFZLENBQUMsWUFBWSxDQUFDLENBQUM7SUFFNUMsb0RBQW9EO0lBQ3BELE1BQU0sU0FBUyxHQUFHLDJDQUFhLFlBQVksRUFBQyxDQUFDO0lBRTdDLE1BQU0sYUFBYSxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsTUFBTSxLQUFLLFNBQVMsQ0FBQyxZQUFZLENBQUMsR0FBRztXQUN2RSxRQUFRLENBQUMsT0FBTyxDQUFDLE1BQU0sS0FBSyxTQUFTLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQztJQUU1RCxNQUFNLEdBQUcsR0FBZ0M7UUFDdkMs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QUU7UUFDaEIsTUFBTSxJQUFJLEtBQUssQ0FBQyxrRUFBa0UsQ0FBQyxDQUFDO0tBQ3JGO0lBRUQsTUFBTSxNQUFNLEdBQUcsTUFBTSx5Q0FBeUMsQ0FDNUQsT0FBTyxFQUNQLFdBQVcsRUFDWCxTQUFTLEVBQ1QsSUFBSSxFQUNKLHVCQUF1QixFQUN2QixPQUFPLENBQUMsTUFBTSxDQUNmLENBQUM7SUFFRixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxDQUFDO0FBQy9CLENBQUM7QUEvQkQsMEZBK0JDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEdvb2dsZSBJbmMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmlvL2xpY2Vuc2VcbiAqL1xuaW1wb3J0IHsgQnVpbGRlckNvbnRleHQgfSBmcm9tICdAYW5ndWxhci1kZXZraXQvYXJjaGl0ZWN0L3NyYy9pbmRleDInO1xuaW1wb3J0IHtcbiAgZXhwZXJpbWVudGFsLFxuICBnZXRTeXN0ZW1QYXRoLFxuICBsb2dnaW5nLFxuICBub3JtYWxpemUsXG4gIHJlc29sdmUsXG4gIHNjaGVtYSxcbiAgdmlydHVhbEZzLFxufSBmcm9tICdAYW5ndWxhci1kZXZraXQvY29yZSc7XG5pbXBvcnQgeyBOb2RlSnNTeW5jSG9zdCB9IGZyb20gJ0Bhbmd1bGFyLWRldmtpdC9jb3JlL25vZGUnO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCAqIGFzIHdlYnBhY2sgZnJvbSAnd2VicGFjayc7XG5pbXBvcnQgeyBXZWJwYWNrQ29uZmlnT3B0aW9ucyB9IGZyb20gJy4uL2FuZ3VsYXItY2xpLWZpbGVzL21vZGVscy9idWlsZC1vcHRpb25zJztcbmltcG9ydCB7IHJlYWRUc2NvbmZpZyB9IGZyb20gJy4uL2FuZ3VsYXItY2xpLWZpbGVzL3V0aWxpdGllcy9yZWFkLXRzY29uZmlnJztcbmltcG9ydCB7IFNjaGVtYSBhcyBCcm93c2VyQnVpbGRlclNjaGVtYSB9IGZyb20gJy4uL2Jyb3dzZXIvc2NoZW1hJztcbmltcG9ydCB7IE5vcm1hbGl6ZWRCcm93c2VyQnVpbGRlclNjaGVtYSwgZGVmYXVsdFByb2dyZXNzLCBub3JtYWxpemVCcm93c2VyU2NoZW1hIH0gZnJvbSAnLi4vdXRpbHMnO1xuXG5jb25zdCBTcGVlZE1lYXN1cmVQbHVnaW4gPSByZXF1aXJlKCdzcGVlZC1tZWFzdXJlLXdlYnBhY2stcGx1Z2luJyk7XG5jb25zdCB3ZWJwYWNrTWVyZ2UgPSByZXF1aXJlKCd3ZWJwYWNrLW1lcmdlJyk7XG5cbnR5cGUgQnJvd3NlcldlYnBhY2tDb25maWdPcHRpb25zID0gV2VicGFja0NvbmZpZ09wdGlvbnM8Tm9ybWFsaXplZEJyb3dzZXJCdWlsZGVyU2NoZW1hPjtcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdlbmVyYXRlV2VicGFja0NvbmZpZyhcbiAgd29ya3NwYWNlUm9vdDogc3RyaW5nLFxuICBwcm9qZWN0Um9vdDogc3RyaW5nLFxuICBzb3VyY2VSb290OiBzdHJpbmcgfCB1bmRlZmluZWQsXG4gIG9wdGlvbnM6IE5vcm1hbGl6ZWRCcm93c2VyQnVpbGRlclNjaGVtYSxcbiAgd2VicGFja1BhcnRpYWxHZW5lcmF0b3I6ICh3Y286IEJyb3dzZXJXZWJwYWNrQ29uZmlnT3B0aW9ucykgPT4gd2VicGFjay5Db25maWd1cmF0aW9uW10sXG4gIGxvZ2dlcjogbG9nZ2luZy5Mb2dnZXJBcGksXG4pOiBQcm9taXNlPHdlYnBhY2suQ29uZmlndXJhdGlvbj4ge1xuICAvLyBFbnN1cmUgQnVpbGQgT3B0aW1pemVyIGlzIG9ubHkgdXNlZCB3aXRoIEFPVC5cbiAgaWYgKG9wdGlvbnMuYnVpbGRPcHRpbWl6ZXIgJiYgIW9wdGlvbnMuYW90KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgJ2J1aWxkT3B0aW1pemVyJyBvcHRpb24gY2Fubm90IGJlIHVzZWQgd2l0aG91dCAnYW90Jy5gKTtcbiAgfVxuXG4gIGNvbnN0IHRzQ29uZmlnUGF0aCA9IHBhdGgucmVzb2x2ZSh3b3Jrc3BhY2VSb290LCBvcHRpb25zLnRzQ29uZmlnKTtcbiAgY29uc3QgdHNDb25maWcgPSByZWFkVHNjb25maWcodHNDb25maWdQYXRoKTtcblxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8taW1wbGljaXQtZGVwZW5kZW5jaWVzXG4gIGNvbnN0IHByb2plY3RUcyA9IGF3YWl0IGltcG9ydCgndHlwZXNjcmlwdCcpO1xuXG4gIGNvbnN0IHN1cHBvcnRFUzIwMTUgPSB0c0NvbmZpZy5vcHRpb25zLnRhcmdldCAhPT0gcHJvamVjdFRzLlNjcmlwdFRhcmdldC5FUzNcbiAgICAmJiB0c0NvbmZpZy5vcHRpb25zLnRhcmdldCAhPT0gcHJvamVjdFRzLlNjcmlwdFRhcmdldC5FUzU7XG5cbiAgY29uc3Qgd2NvOiBCcm93c2VyV2VicGFja0NvbmZpZ09wdGlvbnMgPSB7XG4gICAgcm9vdDogd29ya3NwYWNlUm9vdCxcbiAgICBsb2dnZXI6IGxvZ2dlci5jcmVhdGVDaGlsZCgnd2VicGFja0NvbmZpZ09wdGlvbnMnKSxcbiAgICBwcm9qZWN0Um9vdCxcbiAgICBzb3VyY2VSb290LFxuICAgIGJ1aWxkT3B0aW9uczogb3B0aW9ucyxcbiAgICB0c0NvbmZpZyxcbiAgICB0c0NvbmZpZ1BhdGgsXG4gICAgc3VwcG9ydEVTMjAxNSxcbiAgfTtcblxuICB3Y28uYnVpbGRPcHRpb25zLnByb2dyZXNzID0gZGVmYXVsdFByb2dyZXNzKHdjby5idWlsZE9wdGlvbnMucHJvZ3Jlc3MpO1xuXG4gIGNvbnN0IHBhcnRpYWxzID0gd2VicGFja1BhcnRpYWxHZW5lcmF0b3Iod2NvKTtcbiAgY29uc3Qgd2VicGFja0NvbmZpZyA9IHdlYnBhY2tNZXJnZShwYXJ0aWFscyk7XG5cbiAgaWYgKG9wdGlvbnMucHJvZmlsZSB8fCBwcm9jZXNzLmVudlsnTkdfQlVJTERfUFJPRklMSU5HJ10pIHtcbiAgICBjb25zdCBzbXAgPSBuZXcgU3BlZWRNZWFzdXJlUGx1Z2luKHtcbiAgICAgIG91dHB1dEZvcm1hdDogJ2pzb24nLFxuICAgICAgb3V0cHV0VGFyZ2V0OiBwYXRoLnJlc29sdmUod29ya3NwYWNlUm9vdCwgJ3NwZWVkLW1lYXN1cmUtcGx1Z2luLmpzb24nKSxcbiAgICB9KTtcblxuICAgIHJldHVybiBzbXAud3JhcCh3ZWJwYWNrQ29uZmlnKTtcbiAgfVxuXG4gIHJldHVybiB3ZWJwYWNrQ29uZmlnO1xufVxuXG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZW5lcmF0ZUJyb3dzZXJXZWJwYWNrQ29uZmlnRnJvbVdvcmtzcGFjZShcbiAgb3B0aW9uczogQnJvd3NlckJ1aWxkZXJTY2hlbWEsXG4gIHByb2plY3ROYW1lOiBzdHJpbmcsXG4gIHdvcmtzcGFjZTogZXhwZXJpbWVudGFsLndvcmtzcGFjZS5Xb3Jrc3BhY2UsXG4gIGhvc3Q6IHZpcnR1YWxGcy5Ib3N0PGZzLlN0YXRzPixcbiAgd2VicGFja1BhcnRpYWxHZW5lcmF0b3I6ICh3Y286IEJyb3dzZXJXZWJwYWNrQ29uZmlnT3B0aW9ucykgPT4gd2VicGFjay5Db25maWd1cmF0aW9uW10sXG4gIGxvZ2dlcjogbG9nZ2luZy5Mb2dnZXJBcGksXG4pOiBQcm9taXNlPHdlYnBhY2suQ29uZmlndXJhdGlvbj4ge1xuICAvLyBUT0RPOiBVc2UgYSBiZXR0ZXIgaW50ZXJmYWNlIGZvciB3b3Jrc3BhY2UgYWNjZXNzLlxuICBjb25zdCBwcm9qZWN0Um9vdCA9IHJlc29sdmUod29ya3NwYWNlLnJvb3QsIG5vcm1hbGl6ZSh3b3Jrc3BhY2UuZ2V0UHJvamVjdChwcm9qZWN0TmFtZSkucm9vdCkpO1xuICBjb25zdCBwcm9qZWN0U291cmNlUm9vdCA9IHdvcmtzcGFjZS5nZXRQcm9qZWN0KHByb2plY3ROYW1lKS5zb3VyY2VSb290O1xuICBjb25zdCBzb3VyY2VSb290ID0gcHJvamVjdFNvdXJjZVJvb3RcbiAgICA/IHJlc29sdmUod29ya3NwYWNlLnJvb3QsIG5vcm1hbGl6ZShwcm9qZWN0U291cmNlUm9vdCkpXG4gICAgOiB1bmRlZmluZWQ7XG5cbiAgY29uc3Qgbm9ybWFsaXplZE9wdGlvbnMgPSBub3JtYWxpemVCcm93c2VyU2NoZW1hKFxuICAgIGhvc3QsXG4gICAgd29ya3NwYWNlLnJvb3QsXG4gICAgcHJvamVjdFJvb3QsXG4gICAgc291cmNlUm9vdCxcbiAgICBvcHRpb25zLFxuICApO1xuXG4gIHJldHVybiBnZW5lcmF0ZVdlYnBhY2tDb25maWcoXG4gICAgZ2V0U3lzdGVtUGF0aCh3b3Jrc3BhY2Uucm9vdCksXG4gICAgZ2V0U3lzdGVtUGF0aChwcm9qZWN0Um9vdCksXG4gICAgc291cmNlUm9vdCAmJiBnZXRTeXN0ZW1QYXRoKHNvdXJjZVJvb3QpLFxuICAgIG5vcm1hbGl6ZWRPcHRpb25zLFxuICAgIHdlYnBhY2tQYXJ0aWFsR2VuZXJhdG9yLFxuICAgIGxvZ2dlcixcbiAgKTtcbn1cblxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2VuZXJhdGVCcm93c2VyV2VicGFja0NvbmZpZ0Zyb21Db250ZXh0KFxuICBvcHRpb25zOiBCcm93c2VyQnVpbGRlclNjaGVtYSxcbiAgY29udGV4dDogQnVpbGRlckNvbnRleHQsXG4gIHdlYnBhY2tQYXJ0aWFsR2VuZXJhdG9yOiAod2NvOiBCcm93c2VyV2VicGFja0NvbmZpZ09wdGlvbnMpID0+IHdlYnBhY2suQ29uZmlndXJhdGlvbltdLFxuICBob3N0OiB2aXJ0dWFsRnMuSG9zdDxmcy5TdGF0cz4gPSBuZXcgTm9kZUpzU3luY0hvc3QoKSxcbik6IFByb21pc2U8eyB3b3Jrc3BhY2U6IGV4cGVyaW1lbnRhbC53b3Jrc3BhY2UuV29ya3NwYWNlLCBjb25maWc6IHdlYnBhY2suQ29uZmlndXJhdGlvbiB9PiB7XG4gIGNvbnN0IHJlZ2lzdHJ5ID0gbmV3IHNjaGVtYS5Db3JlU2NoZW1hUmVnaXN0cnkoKTtcbiAgcmVnaXN0cnkuYWRkUG9zdFRyYW5zZm9ybShzY2hlbWEudHJhbnNmb3Jtcy5hZGRVbmRlZmluZWREZWZhdWx0cyk7XG5cbiAgY29uc3Qgd29ya3NwYWNlID0gYXdhaXQgZXhwZXJpbWVudGFsLndvcmtzcGFjZS5Xb3Jrc3BhY2UuZnJvbVBhdGgoXG4gICAgaG9zdCxcbiAgICBub3JtYWxpemUoY29udGV4dC53b3Jrc3BhY2VSb290KSxcbiAgICByZWdpc3RyeSxcbiAgKTtcblxuICBjb25zdCBwcm9qZWN0TmFtZSA9IGNvbnRleHQudGFyZ2V0ID8gY29udGV4dC50YXJnZXQucHJvamVjdCA6IHdvcmtzcGFjZS5nZXREZWZhdWx0UHJvamVjdE5hbWUoKTtcblxuICBpZiAoIXByb2plY3ROYW1lKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdNdXN0IGVpdGhlciBoYXZlIGEgdGFyZ2V0IGZyb20gdGhlIGNvbnRleHQgb3IgYSBkZWZhdWx0IHByb2plY3QuJyk7XG4gIH1cblxuICBjb25zdCBjb25maWcgPSBhd2FpdCBnZW5lcmF0ZUJyb3dzZXJXZWJwYWNrQ29uZmlnRnJvbVdvcmtzcGFjZShcbiAgICBvcHRpb25zLFxuICAgIHByb2plY3ROYW1lLFxuICAgIHdvcmtzcGFjZSxcbiAgICBob3N0LFxuICAgIHdlYnBhY2tQYXJ0aWFsR2VuZXJhdG9yLFxuICAgIGNvbnRleHQubG9nZ2VyLFxuICApO1xuXG4gIHJldHVybiB7IHdvcmtzcGFjZSwgY29uZmlnIH07XG59XG4iXX0=