"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// tslint:disable
// TODO: cleanup this file, it's copied as is from Angular CLI.
const core_1 = require("@angular-devkit/core");
const crypto = require("crypto");
const fs = require("fs");
const semver = require("semver");
const require_project_module_1 = require("../require-project-module");
const operators_1 = require("rxjs/operators");
const rxjs_1 = require("rxjs");
exports.NEW_SW_VERSION = '5.0.0-rc.0';
class CliFilesystem {
    constructor(_host, base) {
        this._host = _host;
        this.base = base;
    }
    list(path) {
        const recursiveList = (path) => this._host.list(path).pipe(
        // Emit each fragment individually.
        operators_1.concatMap(fragments => rxjs_1.from(fragments)), 
        // Join the path with fragment.
        operators_1.map(fragment => core_1.join(path, fragment)), 
        // Emit directory content paths instead of the directory path.
        operators_1.mergeMap(path => this._host.isDirectory(path).pipe(operators_1.concatMap(isDir => isDir ? recursiveList(path) : rxjs_1.of(path)))));
        return recursiveList(this._resolve(path)).pipe(operators_1.map(path => path.replace(this.base, '')), operators_1.toArray()).toPromise().then(x => x, _err => []);
    }
    read(path) {
        return this._host.read(this._resolve(path))
            .toPromise()
            .then(content => core_1.virtualFs.fileBufferToString(content));
    }
    hash(path) {
        const sha1 = crypto.createHash('sha1');
        return this.read(path)
            .then(content => sha1.update(content))
            .then(() => sha1.digest('hex'));
    }
    write(path, content) {
        return this._host.write(this._resolve(path), core_1.virtualFs.stringToFileBuffer(content))
            .toPromise();
    }
    _resolve(path) {
        return core_1.join(core_1.normalize(this.base), path);
    }
}
function usesServiceWorker(projectRoot) {
    let swPackageJsonPath;
    try {
        swPackageJsonPath = require_project_module_1.resolveProjectModule(projectRoot, '@angular/service-worker/package.json');
    }
    catch (_) {
        // @angular/service-worker is not installed
        throw new Error(core_1.tags.stripIndent `
    Your project is configured with serviceWorker = true, but @angular/service-worker
    is not installed. Run \`npm install --save-dev @angular/service-worker\`
    and try again, or run \`ng set apps.0.serviceWorker=false\` in your .angular-cli.json.
  `);
    }
    const swPackageJson = fs.readFileSync(swPackageJsonPath).toString();
    const swVersion = JSON.parse(swPackageJson)['version'];
    if (!semver.gte(swVersion, exports.NEW_SW_VERSION)) {
        throw new Error(core_1.tags.stripIndent `
    The installed version of @angular/service-worker is ${swVersion}. This version of the CLI
    requires the @angular/service-worker version to satisfy ${exports.NEW_SW_VERSION}. Please upgrade
    your service worker version.
  `);
    }
    return true;
}
exports.usesServiceWorker = usesServiceWorker;
function augmentAppWithServiceWorker(host, projectRoot, appRoot, outputPath, baseHref) {
    // Path to the worker script itself.
    const distPath = core_1.normalize(outputPath);
    const workerPath = core_1.normalize(require_project_module_1.resolveProjectModule(core_1.getSystemPath(projectRoot), '@angular/service-worker/ngsw-worker.js'));
    const swConfigPath = require_project_module_1.resolveProjectModule(core_1.getSystemPath(projectRoot), '@angular/service-worker/config');
    const safetyPath = core_1.join(core_1.dirname(workerPath), 'safety-worker.js');
    const configPath = core_1.join(appRoot, 'ngsw-config.json');
    return host.exists(configPath).pipe(operators_1.switchMap(exists => {
        if (!exists) {
            throw new Error(core_1.tags.oneLine `
          Error: Expected to find an ngsw-config.json configuration
          file in the ${appRoot} folder. Either provide one or disable Service Worker
          in your angular.json configuration file.`);
        }
        return host.read(configPath);
    }), operators_1.map(content => JSON.parse(core_1.virtualFs.fileBufferToString(content))), operators_1.switchMap(configJson => {
        const Generator = require(swConfigPath).Generator;
        const gen = new Generator(new CliFilesystem(host, outputPath), baseHref);
        return gen.process(configJson);
    }), operators_1.switchMap(output => {
        const manifest = JSON.stringify(output, null, 2);
        return host.read(workerPath).pipe(operators_1.switchMap(workerCode => {
            return rxjs_1.merge(host.write(core_1.join(distPath, 'ngsw.json'), core_1.virtualFs.stringToFileBuffer(manifest)), host.write(core_1.join(distPath, 'ngsw-worker.js'), workerCode));
        }));
    }), operators_1.switchMap(() => host.exists(safetyPath)), 
    // If @angular/service-worker has the safety script, copy it into two locations.
    operators_1.switchMap(exists => {
        if (!exists) {
            return rxjs_1.of(undefined);
        }
        return host.read(safetyPath).pipe(operators_1.switchMap(safetyCode => {
            return rxjs_1.merge(host.write(core_1.join(distPath, 'worker-basic.min.js'), safetyCode), host.write(core_1.join(distPath, 'safety-worker.js'), safetyCode));
        }));
    }), 
    // Remove all elements, reduce them to a single emit.
    operators_1.reduce(() => { })).toPromise();
}
exports.augmentAppWithServiceWorker = augmentAppWithServiceWorker;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiLi8iLCJzb3VyY2VzIjpbInBhY2thZ2VzL2FuZ3VsYXJfZGV2a2l0L2J1aWxkX2FuZ3VsYXIvc3JjL2FuZ3VsYXItY2xpLWZpbGVzL3V0aWxpdGllcy9zZXJ2aWNlLXdvcmtlci9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGlCQUFpQjtBQUNqQiwrREFBK0Q7QUFDL0QsK0NBQWdIO0FBRWhILGlDQUFpQztBQUNqQyx5QkFBeUI7QUFDekIsaUNBQWlDO0FBRWpDLHNFQUFpRTtBQUNqRSw4Q0FBMkY7QUFDM0YsK0JBQW1EO0FBR3RDLFFBQUEsY0FBYyxHQUFHLFlBQVksQ0FBQztBQUczQztJQUNFLFlBQW9CLEtBQXFCLEVBQVUsSUFBWTtRQUEzQyxVQUFLLEdBQUwsS0FBSyxDQUFnQjtRQUFVLFNBQUksR0FBSixJQUFJLENBQVE7SUFBSSxDQUFDO0lBRXBFLElBQUksQ0FBQyxJQUFZO1FBQ2YsTUFBTSxhQUFhLEdBQUcsQ0FBQyxJQUFVLEVBQW9CLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJO1FBQ2hGLG1DQUFtQztRQUNuQyxxQkFBUyxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsV0FBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3ZDLCtCQUErQjtRQUMvQixlQUFHLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxXQUFJLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ3JDLDhEQUE4RDtRQUM5RCxvQkFBUSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUM5QyxxQkFBUyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUMzRCxDQUNGLENBQ0YsQ0FBQztRQUVGLE1BQU0sQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FDNUMsZUFBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDLEVBQ3hDLG1CQUFPLEVBQUUsQ0FDVixDQUFDLFNBQVMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ3pDLENBQUM7SUFFRCxJQUFJLENBQUMsSUFBWTtRQUNmLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ3hDLFNBQVMsRUFBRTthQUNYLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLGdCQUFTLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztJQUM1RCxDQUFDO0lBRUQsSUFBSSxDQUFDLElBQVk7UUFDZixNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRXZDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQzthQUNuQixJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2FBQ3JDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQUVELEtBQUssQ0FBQyxJQUFZLEVBQUUsT0FBZTtRQUNqQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRSxnQkFBUyxDQUFDLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxDQUFDO2FBQ2hGLFNBQVMsRUFBRSxDQUFDO0lBQ2pCLENBQUM7SUFFTyxRQUFRLENBQUMsSUFBWTtRQUMzQixNQUFNLENBQUMsV0FBSSxDQUFDLGdCQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQzFDLENBQUM7Q0FDRjtBQUVELDJCQUFrQyxXQUFtQjtJQUNuRCxJQUFJLGlCQUFpQixDQUFDO0lBRXRCLElBQUksQ0FBQztRQUNILGlCQUFpQixHQUFHLDZDQUFvQixDQUFDLFdBQVcsRUFBRSxzQ0FBc0MsQ0FBQyxDQUFDO0lBQ2hHLENBQUM7SUFBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ1gsMkNBQTJDO1FBQzNDLE1BQU0sSUFBSSxLQUFLLENBQUMsV0FBSSxDQUFDLFdBQVcsQ0FBQTs7OztHQUlqQyxDQUFDLENBQUM7SUFDSCxDQUFDO0lBRUQsTUFBTSxhQUFhLEdBQUcsRUFBRSxDQUFDLFlBQVksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQ3BFLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUM7SUFFdkQsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxzQkFBYyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzNDLE1BQU0sSUFBSSxLQUFLLENBQUMsV0FBSSxDQUFDLFdBQVcsQ0FBQTswREFDc0IsU0FBUzs4REFDTCxzQkFBYzs7R0FFekUsQ0FBQyxDQUFDO0lBQ0gsQ0FBQztJQUVELE1BQU0sQ0FBQyxJQUFJLENBQUM7QUFDZCxDQUFDO0FBMUJELDhDQTBCQztBQUVELHFDQUNFLElBQW9CLEVBQ3BCLFdBQWlCLEVBQ2pCLE9BQWEsRUFDYixVQUFnQixFQUNoQixRQUFnQjtJQUVoQixvQ0FBb0M7SUFDcEMsTUFBTSxRQUFRLEdBQUcsZ0JBQVMsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUN2QyxNQUFNLFVBQVUsR0FBRyxnQkFBUyxDQUMxQiw2Q0FBb0IsQ0FBQyxvQkFBYSxDQUFDLFdBQVcsQ0FBQyxFQUFFLHdDQUF3QyxDQUFDLENBQzNGLENBQUM7SUFDRixNQUFNLFlBQVksR0FBRyw2Q0FBb0IsQ0FDdkMsb0JBQWEsQ0FBQyxXQUFXLENBQUMsRUFDMUIsZ0NBQWdDLENBQ2pDLENBQUM7SUFDRixNQUFNLFVBQVUsR0FBRyxXQUFJLENBQUMsY0FBTyxDQUFDLFVBQVUsQ0FBQyxFQUFFLGtCQUFrQixDQUFDLENBQUM7SUFDakUsTUFBTSxVQUFVLEdBQUcsV0FBSSxDQUFDLE9BQU8sRUFBRSxrQkFBa0IsQ0FBQyxDQUFDO0lBRXJELE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksQ0FDakMscUJBQVMsQ0FBQyxNQUFNLENBQUMsRUFBRTtRQUNqQixFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDWixNQUFNLElBQUksS0FBSyxDQUFDLFdBQUksQ0FBQyxPQUFPLENBQUE7O3dCQUVaLE9BQU87bURBQ29CLENBQzFDLENBQUM7UUFDSixDQUFDO1FBRUQsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFxQyxDQUFDO0lBQ25FLENBQUMsQ0FBQyxFQUNGLGVBQUcsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsZ0JBQVMsQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQ2pFLHFCQUFTLENBQUMsVUFBVSxDQUFDLEVBQUU7UUFDckIsTUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDLFNBQVMsQ0FBQztRQUNsRCxNQUFNLEdBQUcsR0FBRyxJQUFJLFNBQVMsQ0FBQyxJQUFJLGFBQWEsQ0FBQyxJQUFJLEVBQUUsVUFBVSxDQUFDLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFFekUsTUFBTSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDakMsQ0FBQyxDQUFDLEVBRUYscUJBQVMsQ0FBQyxNQUFNLENBQUMsRUFBRTtRQUNqQixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDakQsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUMvQixxQkFBUyxDQUFDLFVBQVUsQ0FBQyxFQUFFO1lBQ3JCLE1BQU0sQ0FBQyxZQUFLLENBQ1YsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFJLENBQUMsUUFBUSxFQUFFLFdBQVcsQ0FBQyxFQUFFLGdCQUFTLENBQUMsa0JBQWtCLENBQUMsUUFBUSxDQUFDLENBQUMsRUFDL0UsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFJLENBQUMsUUFBUSxFQUFFLGdCQUFnQixDQUFDLEVBQUUsVUFBVSxDQUFDLENBQ3JDLENBQUM7UUFDeEIsQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUMsQ0FBQyxFQUVGLHFCQUFTLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUN4QyxnRkFBZ0Y7SUFDaEYscUJBQVMsQ0FBQyxNQUFNLENBQUMsRUFBRTtRQUNqQixFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDWixNQUFNLENBQUMsU0FBRSxDQUFPLFNBQVMsQ0FBQyxDQUFDO1FBQzdCLENBQUM7UUFFRCxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxJQUFJLENBQy9CLHFCQUFTLENBQUMsVUFBVSxDQUFDLEVBQUU7WUFDckIsTUFBTSxDQUFDLFlBQUssQ0FDVixJQUFJLENBQUMsS0FBSyxDQUFDLFdBQUksQ0FBQyxRQUFRLEVBQUUscUJBQXFCLENBQUMsRUFBRSxVQUFVLENBQUMsRUFDN0QsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFJLENBQUMsUUFBUSxFQUFFLGtCQUFrQixDQUFDLEVBQUUsVUFBVSxDQUFDLENBQ3ZDLENBQUM7UUFDeEIsQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUMsQ0FBQztJQUVGLHFEQUFxRDtJQUNyRCxrQkFBTSxDQUFDLEdBQUcsRUFBRSxHQUFFLENBQUMsQ0FBQyxDQUNqQixDQUFDLFNBQVMsRUFBRSxDQUFDO0FBQ2hCLENBQUM7QUF2RUQsa0VBdUVDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gdHNsaW50OmRpc2FibGVcbi8vIFRPRE86IGNsZWFudXAgdGhpcyBmaWxlLCBpdCdzIGNvcGllZCBhcyBpcyBmcm9tIEFuZ3VsYXIgQ0xJLlxuaW1wb3J0IHsgUGF0aCwgam9pbiwgbm9ybWFsaXplLCB2aXJ0dWFsRnMsIGRpcm5hbWUsIGdldFN5c3RlbVBhdGgsIHRhZ3MsIGZyYWdtZW50IH0gZnJvbSAnQGFuZ3VsYXItZGV2a2l0L2NvcmUnO1xuaW1wb3J0IHsgRmlsZXN5c3RlbSB9IGZyb20gJ0Bhbmd1bGFyL3NlcnZpY2Utd29ya2VyL2NvbmZpZyc7XG5pbXBvcnQgKiBhcyBjcnlwdG8gZnJvbSAnY3J5cHRvJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcbmltcG9ydCAqIGFzIHNlbXZlciBmcm9tICdzZW12ZXInO1xuXG5pbXBvcnQgeyByZXNvbHZlUHJvamVjdE1vZHVsZSB9IGZyb20gJy4uL3JlcXVpcmUtcHJvamVjdC1tb2R1bGUnO1xuaW1wb3J0IHsgbWFwLCByZWR1Y2UsIHN3aXRjaE1hcCwgY29uY2F0TWFwLCBtZXJnZU1hcCwgdG9BcnJheSwgdGFwIH0gZnJvbSBcInJ4anMvb3BlcmF0b3JzXCI7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBtZXJnZSwgb2YsIGZyb20gfSBmcm9tIFwicnhqc1wiO1xuXG5cbmV4cG9ydCBjb25zdCBORVdfU1dfVkVSU0lPTiA9ICc1LjAuMC1yYy4wJztcblxuXG5jbGFzcyBDbGlGaWxlc3lzdGVtIGltcGxlbWVudHMgRmlsZXN5c3RlbSB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgX2hvc3Q6IHZpcnR1YWxGcy5Ib3N0LCBwcml2YXRlIGJhc2U6IHN0cmluZykgeyB9XG5cbiAgbGlzdChwYXRoOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgY29uc3QgcmVjdXJzaXZlTGlzdCA9IChwYXRoOiBQYXRoKTogT2JzZXJ2YWJsZTxQYXRoPiA9PiB0aGlzLl9ob3N0Lmxpc3QocGF0aCkucGlwZShcbiAgICAgIC8vIEVtaXQgZWFjaCBmcmFnbWVudCBpbmRpdmlkdWFsbHkuXG4gICAgICBjb25jYXRNYXAoZnJhZ21lbnRzID0+IGZyb20oZnJhZ21lbnRzKSksXG4gICAgICAvLyBKb2luIHRoZSBwYXRoIHdpdGggZnJhZ21lbnQuXG4gICAgICBtYXAoZnJhZ21lbnQgPT4gam9pbihwYXRoLCBmcmFnbWVudCkpLFxuICAgICAgLy8gRW1pdCBkaXJlY3RvcnkgY29udGVudCBwYXRocyBpbnN0ZWFkIG9mIHRoZSBkaXJlY3RvcnkgcGF0aC5cbiAgICAgIG1lcmdlTWFwKHBhdGggPT4gdGhpcy5faG9zdC5pc0RpcmVjdG9yeShwYXRoKS5waXBlKFxuICAgICAgICAgIGNvbmNhdE1hcChpc0RpciA9PiBpc0RpciA/IHJlY3Vyc2l2ZUxpc3QocGF0aCkgOiBvZihwYXRoKSlcbiAgICAgICAgKVxuICAgICAgKSxcbiAgICApO1xuXG4gICAgcmV0dXJuIHJlY3Vyc2l2ZUxpc3QodGhpcy5fcmVzb2x2ZShwYXRoKSkucGlwZShcbiAgICAgIG1hcChwYXRoID0+IHBhdGgucmVwbGFjZSh0aGlzLmJhc2UsICcnKSksXG4gICAgICB0b0FycmF5KCksXG4gICAgKS50b1Byb21pc2UoKS50aGVuKHggPT4geCwgX2VyciA9PiBbXSk7XG4gIH1cblxuICByZWFkKHBhdGg6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIHRoaXMuX2hvc3QucmVhZCh0aGlzLl9yZXNvbHZlKHBhdGgpKVxuICAgICAgLnRvUHJvbWlzZSgpXG4gICAgICAudGhlbihjb250ZW50ID0+IHZpcnR1YWxGcy5maWxlQnVmZmVyVG9TdHJpbmcoY29udGVudCkpO1xuICB9XG5cbiAgaGFzaChwYXRoOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGNvbnN0IHNoYTEgPSBjcnlwdG8uY3JlYXRlSGFzaCgnc2hhMScpO1xuXG4gICAgcmV0dXJuIHRoaXMucmVhZChwYXRoKVxuICAgICAgLnRoZW4oY29udGVudCA9PiBzaGExLnVwZGF0ZShjb250ZW50KSlcbiAgICAgIC50aGVuKCgpID0+IHNoYTEuZGlnZXN0KCdoZXgnKSk7XG4gIH1cblxuICB3cml0ZShwYXRoOiBzdHJpbmcsIGNvbnRlbnQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIHJldHVybiB0aGlzLl9ob3N0LndyaXRlKHRoaXMuX3Jlc29sdmUocGF0aCksIHZpcnR1YWxGcy5zdHJpbmdUb0ZpbGVCdWZmZXIoY29udGVudCkpXG4gICAgICAudG9Qcm9taXNlKCk7XG4gIH1cblxuICBwcml2YXRlIF9yZXNvbHZlKHBhdGg6IHN0cmluZyk6IFBhdGgge1xuICAgIHJldHVybiBqb2luKG5vcm1hbGl6ZSh0aGlzLmJhc2UpLCBwYXRoKTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gdXNlc1NlcnZpY2VXb3JrZXIocHJvamVjdFJvb3Q6IHN0cmluZyk6IGJvb2xlYW4ge1xuICBsZXQgc3dQYWNrYWdlSnNvblBhdGg7XG5cbiAgdHJ5IHtcbiAgICBzd1BhY2thZ2VKc29uUGF0aCA9IHJlc29sdmVQcm9qZWN0TW9kdWxlKHByb2plY3RSb290LCAnQGFuZ3VsYXIvc2VydmljZS13b3JrZXIvcGFja2FnZS5qc29uJyk7XG4gIH0gY2F0Y2ggKF8pIHtcbiAgICAvLyBAYW5ndWxhci9zZXJ2aWNlLXdvcmtlciBpcyBub3QgaW5zdGFsbGVkXG4gICAgdGhyb3cgbmV3IEVycm9yKHRhZ3Muc3RyaXBJbmRlbnRgXG4gICAgWW91ciBwcm9qZWN0IGlzIGNvbmZpZ3VyZWQgd2l0aCBzZXJ2aWNlV29ya2VyID0gdHJ1ZSwgYnV0IEBhbmd1bGFyL3NlcnZpY2Utd29ya2VyXG4gICAgaXMgbm90IGluc3RhbGxlZC4gUnVuIFxcYG5wbSBpbnN0YWxsIC0tc2F2ZS1kZXYgQGFuZ3VsYXIvc2VydmljZS13b3JrZXJcXGBcbiAgICBhbmQgdHJ5IGFnYWluLCBvciBydW4gXFxgbmcgc2V0IGFwcHMuMC5zZXJ2aWNlV29ya2VyPWZhbHNlXFxgIGluIHlvdXIgLmFuZ3VsYXItY2xpLmpzb24uXG4gIGApO1xuICB9XG5cbiAgY29uc3Qgc3dQYWNrYWdlSnNvbiA9IGZzLnJlYWRGaWxlU3luYyhzd1BhY2thZ2VKc29uUGF0aCkudG9TdHJpbmcoKTtcbiAgY29uc3Qgc3dWZXJzaW9uID0gSlNPTi5wYXJzZShzd1BhY2thZ2VKc29uKVsndmVyc2lvbiddO1xuXG4gIGlmICghc2VtdmVyLmd0ZShzd1ZlcnNpb24sIE5FV19TV19WRVJTSU9OKSkge1xuICAgIHRocm93IG5ldyBFcnJvcih0YWdzLnN0cmlwSW5kZW50YFxuICAgIFRoZSBpbnN0YWxsZWQgdmVyc2lvbiBvZiBAYW5ndWxhci9zZXJ2aWNlLXdvcmtlciBpcyAke3N3VmVyc2lvbn0uIFRoaXMgdmVyc2lvbiBvZiB0aGUgQ0xJXG4gICAgcmVxdWlyZXMgdGhlIEBhbmd1bGFyL3NlcnZpY2Utd29ya2VyIHZlcnNpb24gdG8gc2F0aXNmeSAke05FV19TV19WRVJTSU9OfS4gUGxlYXNlIHVwZ3JhZGVcbiAgICB5b3VyIHNlcnZpY2Ugd29ya2VyIHZlcnNpb24uXG4gIGApO1xuICB9XG5cbiAgcmV0dXJuIHRydWU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhdWdtZW50QXBwV2l0aFNlcnZpY2VXb3JrZXIoXG4gIGhvc3Q6IHZpcnR1YWxGcy5Ib3N0LFxuICBwcm9qZWN0Um9vdDogUGF0aCxcbiAgYXBwUm9vdDogUGF0aCxcbiAgb3V0cHV0UGF0aDogUGF0aCxcbiAgYmFzZUhyZWY6IHN0cmluZyxcbik6IFByb21pc2U8dm9pZD4ge1xuICAvLyBQYXRoIHRvIHRoZSB3b3JrZXIgc2NyaXB0IGl0c2VsZi5cbiAgY29uc3QgZGlzdFBhdGggPSBub3JtYWxpemUob3V0cHV0UGF0aCk7XG4gIGNvbnN0IHdvcmtlclBhdGggPSBub3JtYWxpemUoXG4gICAgcmVzb2x2ZVByb2plY3RNb2R1bGUoZ2V0U3lzdGVtUGF0aChwcm9qZWN0Um9vdCksICdAYW5ndWxhci9zZXJ2aWNlLXdvcmtlci9uZ3N3LXdvcmtlci5qcycpLFxuICApO1xuICBjb25zdCBzd0NvbmZpZ1BhdGggPSByZXNvbHZlUHJvamVjdE1vZHVsZShcbiAgICBnZXRTeXN0ZW1QYXRoKHByb2plY3RSb290KSxcbiAgICAnQGFuZ3VsYXIvc2VydmljZS13b3JrZXIvY29uZmlnJyxcbiAgKTtcbiAgY29uc3Qgc2FmZXR5UGF0aCA9IGpvaW4oZGlybmFtZSh3b3JrZXJQYXRoKSwgJ3NhZmV0eS13b3JrZXIuanMnKTtcbiAgY29uc3QgY29uZmlnUGF0aCA9IGpvaW4oYXBwUm9vdCwgJ25nc3ctY29uZmlnLmpzb24nKTtcblxuICByZXR1cm4gaG9zdC5leGlzdHMoY29uZmlnUGF0aCkucGlwZShcbiAgICBzd2l0Y2hNYXAoZXhpc3RzID0+IHtcbiAgICAgIGlmICghZXhpc3RzKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcih0YWdzLm9uZUxpbmVgXG4gICAgICAgICAgRXJyb3I6IEV4cGVjdGVkIHRvIGZpbmQgYW4gbmdzdy1jb25maWcuanNvbiBjb25maWd1cmF0aW9uXG4gICAgICAgICAgZmlsZSBpbiB0aGUgJHthcHBSb290fSBmb2xkZXIuIEVpdGhlciBwcm92aWRlIG9uZSBvciBkaXNhYmxlIFNlcnZpY2UgV29ya2VyXG4gICAgICAgICAgaW4geW91ciBhbmd1bGFyLmpzb24gY29uZmlndXJhdGlvbiBmaWxlLmAsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBob3N0LnJlYWQoY29uZmlnUGF0aCkgYXMgT2JzZXJ2YWJsZTx2aXJ0dWFsRnMuRmlsZUJ1ZmZlcj47XG4gICAgfSksXG4gICAgbWFwKGNvbnRlbnQgPT4gSlNPTi5wYXJzZSh2aXJ0dWFsRnMuZmlsZUJ1ZmZlclRvU3RyaW5nKGNvbnRlbnQpKSksXG4gICAgc3dpdGNoTWFwKGNvbmZpZ0pzb24gPT4ge1xuICAgICAgY29uc3QgR2VuZXJhdG9yID0gcmVxdWlyZShzd0NvbmZpZ1BhdGgpLkdlbmVyYXRvcjtcbiAgICAgIGNvbnN0IGdlbiA9IG5ldyBHZW5lcmF0b3IobmV3IENsaUZpbGVzeXN0ZW0oaG9zdCwgb3V0cHV0UGF0aCksIGJhc2VIcmVmKTtcblxuICAgICAgcmV0dXJuIGdlbi5wcm9jZXNzKGNvbmZpZ0pzb24pO1xuICAgIH0pLFxuXG4gICAgc3dpdGNoTWFwKG91dHB1dCA9PiB7XG4gICAgICBjb25zdCBtYW5pZmVzdCA9IEpTT04uc3RyaW5naWZ5KG91dHB1dCwgbnVsbCwgMik7XG4gICAgICByZXR1cm4gaG9zdC5yZWFkKHdvcmtlclBhdGgpLnBpcGUoXG4gICAgICAgIHN3aXRjaE1hcCh3b3JrZXJDb2RlID0+IHtcbiAgICAgICAgICByZXR1cm4gbWVyZ2UoXG4gICAgICAgICAgICBob3N0LndyaXRlKGpvaW4oZGlzdFBhdGgsICduZ3N3Lmpzb24nKSwgdmlydHVhbEZzLnN0cmluZ1RvRmlsZUJ1ZmZlcihtYW5pZmVzdCkpLFxuICAgICAgICAgICAgaG9zdC53cml0ZShqb2luKGRpc3RQYXRoLCAnbmdzdy13b3JrZXIuanMnKSwgd29ya2VyQ29kZSksXG4gICAgICAgICAgKSBhcyBPYnNlcnZhYmxlPHZvaWQ+O1xuICAgICAgICB9KSxcbiAgICAgICk7XG4gICAgfSksXG5cbiAgICBzd2l0Y2hNYXAoKCkgPT4gaG9zdC5leGlzdHMoc2FmZXR5UGF0aCkpLFxuICAgIC8vIElmIEBhbmd1bGFyL3NlcnZpY2Utd29ya2VyIGhhcyB0aGUgc2FmZXR5IHNjcmlwdCwgY29weSBpdCBpbnRvIHR3byBsb2NhdGlvbnMuXG4gICAgc3dpdGNoTWFwKGV4aXN0cyA9PiB7XG4gICAgICBpZiAoIWV4aXN0cykge1xuICAgICAgICByZXR1cm4gb2Y8dm9pZD4odW5kZWZpbmVkKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGhvc3QucmVhZChzYWZldHlQYXRoKS5waXBlKFxuICAgICAgICBzd2l0Y2hNYXAoc2FmZXR5Q29kZSA9PiB7XG4gICAgICAgICAgcmV0dXJuIG1lcmdlKFxuICAgICAgICAgICAgaG9zdC53cml0ZShqb2luKGRpc3RQYXRoLCAnd29ya2VyLWJhc2ljLm1pbi5qcycpLCBzYWZldHlDb2RlKSxcbiAgICAgICAgICAgIGhvc3Qud3JpdGUoam9pbihkaXN0UGF0aCwgJ3NhZmV0eS13b3JrZXIuanMnKSwgc2FmZXR5Q29kZSksXG4gICAgICAgICAgKSBhcyBPYnNlcnZhYmxlPHZvaWQ+O1xuICAgICAgICB9KSxcbiAgICAgICk7XG4gICAgfSksXG5cbiAgICAvLyBSZW1vdmUgYWxsIGVsZW1lbnRzLCByZWR1Y2UgdGhlbSB0byBhIHNpbmdsZSBlbWl0LlxuICAgIHJlZHVjZSgoKSA9PiB7fSksXG4gICkudG9Qcm9taXNlKCk7XG59XG4iXX0=