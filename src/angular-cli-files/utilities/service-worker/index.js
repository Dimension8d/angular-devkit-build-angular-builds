"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * @license
 * Copyright Google Inc. All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
// tslint:disable
// TODO: cleanup this file, it's copied as is from Angular CLI.
const core_1 = require("@angular-devkit/core");
const crypto = require("crypto");
const fs = require("fs");
const semver = require("semver");
const require_project_module_1 = require("../require-project-module");
const operators_1 = require("rxjs/operators");
const rxjs_1 = require("rxjs");
exports.NEW_SW_VERSION = '5.0.0-rc.0';
class CliFilesystem {
    constructor(_host, base) {
        this._host = _host;
        this.base = base;
    }
    list(path) {
        const recursiveList = (path) => this._host.list(path).pipe(
        // Emit each fragment individually.
        operators_1.concatMap(fragments => rxjs_1.from(fragments)), 
        // Join the path with fragment.
        operators_1.map(fragment => core_1.join(path, fragment)), 
        // Emit directory content paths instead of the directory path.
        operators_1.mergeMap(path => this._host.isDirectory(path).pipe(operators_1.concatMap(isDir => isDir ? recursiveList(path) : rxjs_1.of(path)))));
        return recursiveList(this._resolve(path)).pipe(operators_1.map(path => path.replace(this.base, '')), operators_1.toArray()).toPromise().then(x => x, _err => []);
    }
    read(path) {
        return this._readIntoBuffer(path)
            .then(content => core_1.virtualFs.fileBufferToString(content));
    }
    hash(path) {
        const sha1 = crypto.createHash('sha1');
        return this._readIntoBuffer(path)
            .then(content => sha1.update(Buffer.from(content)))
            .then(() => sha1.digest('hex'));
    }
    write(path, content) {
        return this._host.write(this._resolve(path), core_1.virtualFs.stringToFileBuffer(content))
            .toPromise();
    }
    _readIntoBuffer(path) {
        return this._host.read(this._resolve(path))
            .toPromise();
    }
    _resolve(path) {
        return core_1.join(core_1.normalize(this.base), path);
    }
}
function usesServiceWorker(projectRoot) {
    let swPackageJsonPath;
    try {
        swPackageJsonPath = require_project_module_1.resolveProjectModule(projectRoot, '@angular/service-worker/package.json');
    }
    catch (_) {
        // @angular/service-worker is not installed
        throw new Error(core_1.tags.stripIndent `
    Your project is configured with serviceWorker = true, but @angular/service-worker
    is not installed. Run \`npm install --save-dev @angular/service-worker\`
    and try again, or run \`ng set apps.0.serviceWorker=false\` in your .angular-cli.json.
  `);
    }
    const swPackageJson = fs.readFileSync(swPackageJsonPath).toString();
    const swVersion = JSON.parse(swPackageJson)['version'];
    if (!semver.gte(swVersion, exports.NEW_SW_VERSION)) {
        throw new Error(core_1.tags.stripIndent `
    The installed version of @angular/service-worker is ${swVersion}. This version of the CLI
    requires the @angular/service-worker version to satisfy ${exports.NEW_SW_VERSION}. Please upgrade
    your service worker version.
  `);
    }
    return true;
}
exports.usesServiceWorker = usesServiceWorker;
function augmentAppWithServiceWorker(host, projectRoot, appRoot, outputPath, baseHref, ngswConfigPath) {
    // Path to the worker script itself.
    const distPath = core_1.normalize(outputPath);
    const workerPath = core_1.normalize(require_project_module_1.resolveProjectModule(core_1.getSystemPath(projectRoot), '@angular/service-worker/ngsw-worker.js'));
    const swConfigPath = require_project_module_1.resolveProjectModule(core_1.getSystemPath(projectRoot), '@angular/service-worker/config');
    const safetyPath = core_1.join(core_1.dirname(workerPath), 'safety-worker.js');
    const configPath = ngswConfigPath || core_1.join(appRoot, 'ngsw-config.json');
    return host.exists(configPath).pipe(operators_1.switchMap(exists => {
        if (!exists) {
            throw new Error(core_1.tags.oneLine `
          Error: Expected to find an ngsw-config.json configuration
          file in the ${appRoot} folder. Either provide one or disable Service Worker
          in your angular.json configuration file.`);
        }
        return host.read(configPath);
    }), operators_1.map(content => JSON.parse(core_1.virtualFs.fileBufferToString(content))), operators_1.switchMap(configJson => {
        const Generator = require(swConfigPath).Generator;
        const gen = new Generator(new CliFilesystem(host, outputPath), baseHref);
        return gen.process(configJson);
    }), operators_1.switchMap(output => {
        const manifest = JSON.stringify(output, null, 2);
        return host.read(workerPath).pipe(operators_1.switchMap(workerCode => {
            return rxjs_1.merge(host.write(core_1.join(distPath, 'ngsw.json'), core_1.virtualFs.stringToFileBuffer(manifest)), host.write(core_1.join(distPath, 'ngsw-worker.js'), workerCode));
        }));
    }), operators_1.switchMap(() => host.exists(safetyPath)), 
    // If @angular/service-worker has the safety script, copy it into two locations.
    operators_1.switchMap(exists => {
        if (!exists) {
            return rxjs_1.of(undefined);
        }
        return host.read(safetyPath).pipe(operators_1.switchMap(safetyCode => {
            return rxjs_1.merge(host.write(core_1.join(distPath, 'worker-basic.min.js'), safetyCode), host.write(core_1.join(distPath, 'safety-worker.js'), safetyCode));
        }));
    }), 
    // Remove all elements, reduce them to a single emit.
    operators_1.reduce(() => { })).toPromise();
}
exports.augmentAppWithServiceWorker = augmentAppWithServiceWorker;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiLi8iLCJzb3VyY2VzIjpbInBhY2thZ2VzL2FuZ3VsYXJfZGV2a2l0L2J1aWxkX2FuZ3VsYXIvc3JjL2FuZ3VsYXItY2xpLWZpbGVzL3V0aWxpdGllcy9zZXJ2aWNlLXdvcmtlci9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBOzs7Ozs7R0FNRztBQUNILGlCQUFpQjtBQUNqQiwrREFBK0Q7QUFDL0QsK0NBQWdIO0FBRWhILGlDQUFpQztBQUNqQyx5QkFBeUI7QUFDekIsaUNBQWlDO0FBRWpDLHNFQUFpRTtBQUNqRSw4Q0FBMkY7QUFDM0YsK0JBQW1EO0FBR3RDLFFBQUEsY0FBYyxHQUFHLFlBQVksQ0FBQztBQUczQztJQUNFLFlBQW9CLEtBQXFCLEVBQVUsSUFBWTtRQUEzQyxVQUFLLEdBQUwsS0FBSyxDQUFnQjtRQUFVLFNBQUksR0FBSixJQUFJLENBQVE7SUFBSSxDQUFDO0lBRXBFLElBQUksQ0FBQyxJQUFZO1FBQ2YsTUFBTSxhQUFhLEdBQUcsQ0FBQyxJQUFVLEVBQW9CLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJO1FBQ2hGLG1DQUFtQztRQUNuQyxxQkFBUyxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsV0FBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3ZDLCtCQUErQjtRQUMvQixlQUFHLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxXQUFJLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ3JDLDhEQUE4RDtRQUM5RCxvQkFBUSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUM5QyxxQkFBUyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FB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UUFBUSxFQUFFLGtCQUFrQixDQUFDLEVBQUUsVUFBVSxDQUFDLENBQ3ZDLENBQUM7UUFDeEIsQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUMsQ0FBQztJQUVGLHFEQUFxRDtJQUNyRCxrQkFBTSxDQUFDLEdBQUcsRUFBRSxHQUFFLENBQUMsQ0FBQyxDQUNqQixDQUFDLFNBQVMsRUFBRSxDQUFDO0FBQ2hCLENBQUM7QUF4RUQsa0VBd0VDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEdvb2dsZSBJbmMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmlvL2xpY2Vuc2VcbiAqL1xuLy8gdHNsaW50OmRpc2FibGVcbi8vIFRPRE86IGNsZWFudXAgdGhpcyBmaWxlLCBpdCdzIGNvcGllZCBhcyBpcyBmcm9tIEFuZ3VsYXIgQ0xJLlxuaW1wb3J0IHsgUGF0aCwgam9pbiwgbm9ybWFsaXplLCB2aXJ0dWFsRnMsIGRpcm5hbWUsIGdldFN5c3RlbVBhdGgsIHRhZ3MsIGZyYWdtZW50IH0gZnJvbSAnQGFuZ3VsYXItZGV2a2l0L2NvcmUnO1xuaW1wb3J0IHsgRmlsZXN5c3RlbSB9IGZyb20gJ0Bhbmd1bGFyL3NlcnZpY2Utd29ya2VyL2NvbmZpZyc7XG5pbXBvcnQgKiBhcyBjcnlwdG8gZnJvbSAnY3J5cHRvJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcbmltcG9ydCAqIGFzIHNlbXZlciBmcm9tICdzZW12ZXInO1xuXG5pbXBvcnQgeyByZXNvbHZlUHJvamVjdE1vZHVsZSB9IGZyb20gJy4uL3JlcXVpcmUtcHJvamVjdC1tb2R1bGUnO1xuaW1wb3J0IHsgbWFwLCByZWR1Y2UsIHN3aXRjaE1hcCwgY29uY2F0TWFwLCBtZXJnZU1hcCwgdG9BcnJheSwgdGFwIH0gZnJvbSBcInJ4anMvb3BlcmF0b3JzXCI7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBtZXJnZSwgb2YsIGZyb20gfSBmcm9tIFwicnhqc1wiO1xuXG5cbmV4cG9ydCBjb25zdCBORVdfU1dfVkVSU0lPTiA9ICc1LjAuMC1yYy4wJztcblxuXG5jbGFzcyBDbGlGaWxlc3lzdGVtIGltcGxlbWVudHMgRmlsZXN5c3RlbSB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgX2hvc3Q6IHZpcnR1YWxGcy5Ib3N0LCBwcml2YXRlIGJhc2U6IHN0cmluZykgeyB9XG5cbiAgbGlzdChwYXRoOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgY29uc3QgcmVjdXJzaXZlTGlzdCA9IChwYXRoOiBQYXRoKTogT2JzZXJ2YWJsZTxQYXRoPiA9PiB0aGlzLl9ob3N0Lmxpc3QocGF0aCkucGlwZShcbiAgICAgIC8vIEVtaXQgZWFjaCBmcmFnbWVudCBpbmRpdmlkdWFsbHkuXG4gICAgICBjb25jYXRNYXAoZnJhZ21lbnRzID0+IGZyb20oZnJhZ21lbnRzKSksXG4gICAgICAvLyBKb2luIHRoZSBwYXRoIHdpdGggZnJhZ21lbnQuXG4gICAgICBtYXAoZnJhZ21lbnQgPT4gam9pbihwYXRoLCBmcmFnbWVudCkpLFxuICAgICAgLy8gRW1pdCBkaXJlY3RvcnkgY29udGVudCBwYXRocyBpbnN0ZWFkIG9mIHRoZSBkaXJlY3RvcnkgcGF0aC5cbiAgICAgIG1lcmdlTWFwKHBhdGggPT4gdGhpcy5faG9zdC5pc0RpcmVjdG9yeShwYXRoKS5waXBlKFxuICAgICAgICAgIGNvbmNhdE1hcChpc0RpciA9PiBpc0RpciA/IHJlY3Vyc2l2ZUxpc3QocGF0aCkgOiBvZihwYXRoKSlcbiAgICAgICAgKVxuICAgICAgKSxcbiAgICApO1xuXG4gICAgcmV0dXJuIHJlY3Vyc2l2ZUxpc3QodGhpcy5fcmVzb2x2ZShwYXRoKSkucGlwZShcbiAgICAgIG1hcChwYXRoID0+IHBhdGgucmVwbGFjZSh0aGlzLmJhc2UsICcnKSksXG4gICAgICB0b0FycmF5KCksXG4gICAgKS50b1Byb21pc2UoKS50aGVuKHggPT4geCwgX2VyciA9PiBbXSk7XG4gIH1cblxuICByZWFkKHBhdGg6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIHRoaXMuX3JlYWRJbnRvQnVmZmVyKHBhdGgpXG4gICAgICAudGhlbihjb250ZW50ID0+IHZpcnR1YWxGcy5maWxlQnVmZmVyVG9TdHJpbmcoY29udGVudCkpO1xuICB9XG5cbiAgaGFzaChwYXRoOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGNvbnN0IHNoYTEgPSBjcnlwdG8uY3JlYXRlSGFzaCgnc2hhMScpO1xuXG4gICAgcmV0dXJuIHRoaXMuX3JlYWRJbnRvQnVmZmVyKHBhdGgpXG4gICAgICAudGhlbihjb250ZW50ID0+IHNoYTEudXBkYXRlKEJ1ZmZlci5mcm9tKGNvbnRlbnQpKSlcbiAgICAgIC50aGVuKCgpID0+IHNoYTEuZGlnZXN0KCdoZXgnKSk7XG4gIH1cblxuICB3cml0ZShwYXRoOiBzdHJpbmcsIGNvbnRlbnQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIHJldHVybiB0aGlzLl9ob3N0LndyaXRlKHRoaXMuX3Jlc29sdmUocGF0aCksIHZpcnR1YWxGcy5zdHJpbmdUb0ZpbGVCdWZmZXIoY29udGVudCkpXG4gICAgICAudG9Qcm9taXNlKCk7XG4gIH1cblxuICBwcml2YXRlIF9yZWFkSW50b0J1ZmZlcihwYXRoOiBzdHJpbmcpOiBQcm9taXNlPHZpcnR1YWxGcy5GaWxlQnVmZmVyPiB7XG4gICAgcmV0dXJuIHRoaXMuX2hvc3QucmVhZCh0aGlzLl9yZXNvbHZlKHBhdGgpKVxuICAgICAgLnRvUHJvbWlzZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBfcmVzb2x2ZShwYXRoOiBzdHJpbmcpOiBQYXRoIHtcbiAgICByZXR1cm4gam9pbihub3JtYWxpemUodGhpcy5iYXNlKSwgcGF0aCk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHVzZXNTZXJ2aWNlV29ya2VyKHByb2plY3RSb290OiBzdHJpbmcpOiBib29sZWFuIHtcbiAgbGV0IHN3UGFja2FnZUpzb25QYXRoO1xuXG4gIHRyeSB7XG4gICAgc3dQYWNrYWdlSnNvblBhdGggPSByZXNvbHZlUHJvamVjdE1vZHVsZShwcm9qZWN0Um9vdCwgJ0Bhbmd1bGFyL3NlcnZpY2Utd29ya2VyL3BhY2thZ2UuanNvbicpO1xuICB9IGNhdGNoIChfKSB7XG4gICAgLy8gQGFuZ3VsYXIvc2VydmljZS13b3JrZXIgaXMgbm90IGluc3RhbGxlZFxuICAgIHRocm93IG5ldyBFcnJvcih0YWdzLnN0cmlwSW5kZW50YFxuICAgIFlvdXIgcHJvamVjdCBpcyBjb25maWd1cmVkIHdpdGggc2VydmljZVdvcmtlciA9IHRydWUsIGJ1dCBAYW5ndWxhci9zZXJ2aWNlLXdvcmtlclxuICAgIGlzIG5vdCBpbnN0YWxsZWQuIFJ1biBcXGBucG0gaW5zdGFsbCAtLXNhdmUtZGV2IEBhbmd1bGFyL3NlcnZpY2Utd29ya2VyXFxgXG4gICAgYW5kIHRyeSBhZ2Fpbiwgb3IgcnVuIFxcYG5nIHNldCBhcHBzLjAuc2VydmljZVdvcmtlcj1mYWxzZVxcYCBpbiB5b3VyIC5hbmd1bGFyLWNsaS5qc29uLlxuICBgKTtcbiAgfVxuXG4gIGNvbnN0IHN3UGFja2FnZUpzb24gPSBmcy5yZWFkRmlsZVN5bmMoc3dQYWNrYWdlSnNvblBhdGgpLnRvU3RyaW5nKCk7XG4gIGNvbnN0IHN3VmVyc2lvbiA9IEpTT04ucGFyc2Uoc3dQYWNrYWdlSnNvbilbJ3ZlcnNpb24nXTtcblxuICBpZiAoIXNlbXZlci5ndGUoc3dWZXJzaW9uLCBORVdfU1dfVkVSU0lPTikpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IodGFncy5zdHJpcEluZGVudGBcbiAgICBUaGUgaW5zdGFsbGVkIHZlcnNpb24gb2YgQGFuZ3VsYXIvc2VydmljZS13b3JrZXIgaXMgJHtzd1ZlcnNpb259LiBUaGlzIHZlcnNpb24gb2YgdGhlIENMSVxuICAgIHJlcXVpcmVzIHRoZSBAYW5ndWxhci9zZXJ2aWNlLXdvcmtlciB2ZXJzaW9uIHRvIHNhdGlzZnkgJHtORVdfU1dfVkVSU0lPTn0uIFBsZWFzZSB1cGdyYWRlXG4gICAgeW91ciBzZXJ2aWNlIHdvcmtlciB2ZXJzaW9uLlxuICBgKTtcbiAgfVxuXG4gIHJldHVybiB0cnVlO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYXVnbWVudEFwcFdpdGhTZXJ2aWNlV29ya2VyKFxuICBob3N0OiB2aXJ0dWFsRnMuSG9zdCxcbiAgcHJvamVjdFJvb3Q6IFBhdGgsXG4gIGFwcFJvb3Q6IFBhdGgsXG4gIG91dHB1dFBhdGg6IFBhdGgsXG4gIGJhc2VIcmVmOiBzdHJpbmcsXG4gIG5nc3dDb25maWdQYXRoPzogc3RyaW5nLFxuKTogUHJvbWlzZTx2b2lkPiB7XG4gIC8vIFBhdGggdG8gdGhlIHdvcmtlciBzY3JpcHQgaXRzZWxmLlxuICBjb25zdCBkaXN0UGF0aCA9IG5vcm1hbGl6ZShvdXRwdXRQYXRoKTtcbiAgY29uc3Qgd29ya2VyUGF0aCA9IG5vcm1hbGl6ZShcbiAgICByZXNvbHZlUHJvamVjdE1vZHVsZShnZXRTeXN0ZW1QYXRoKHByb2plY3RSb290KSwgJ0Bhbmd1bGFyL3NlcnZpY2Utd29ya2VyL25nc3ctd29ya2VyLmpzJyksXG4gICk7XG4gIGNvbnN0IHN3Q29uZmlnUGF0aCA9IHJlc29sdmVQcm9qZWN0TW9kdWxlKFxuICAgIGdldFN5c3RlbVBhdGgocHJvamVjdFJvb3QpLFxuICAgICdAYW5ndWxhci9zZXJ2aWNlLXdvcmtlci9jb25maWcnLFxuICApO1xuICBjb25zdCBzYWZldHlQYXRoID0gam9pbihkaXJuYW1lKHdvcmtlclBhdGgpLCAnc2FmZXR5LXdvcmtlci5qcycpO1xuICBjb25zdCBjb25maWdQYXRoID0gbmdzd0NvbmZpZ1BhdGggYXMgUGF0aCB8fCBqb2luKGFwcFJvb3QsICduZ3N3LWNvbmZpZy5qc29uJyk7XG5cbiAgcmV0dXJuIGhvc3QuZXhpc3RzKGNvbmZpZ1BhdGgpLnBpcGUoXG4gICAgc3dpdGNoTWFwKGV4aXN0cyA9PiB7XG4gICAgICBpZiAoIWV4aXN0cykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IodGFncy5vbmVMaW5lYFxuICAgICAgICAgIEVycm9yOiBFeHBlY3RlZCB0byBmaW5kIGFuIG5nc3ctY29uZmlnLmpzb24gY29uZmlndXJhdGlvblxuICAgICAgICAgIGZpbGUgaW4gdGhlICR7YXBwUm9vdH0gZm9sZGVyLiBFaXRoZXIgcHJvdmlkZSBvbmUgb3IgZGlzYWJsZSBTZXJ2aWNlIFdvcmtlclxuICAgICAgICAgIGluIHlvdXIgYW5ndWxhci5qc29uIGNvbmZpZ3VyYXRpb24gZmlsZS5gLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gaG9zdC5yZWFkKGNvbmZpZ1BhdGgpIGFzIE9ic2VydmFibGU8dmlydHVhbEZzLkZpbGVCdWZmZXI+O1xuICAgIH0pLFxuICAgIG1hcChjb250ZW50ID0+IEpTT04ucGFyc2UodmlydHVhbEZzLmZpbGVCdWZmZXJUb1N0cmluZyhjb250ZW50KSkpLFxuICAgIHN3aXRjaE1hcChjb25maWdKc29uID0+IHtcbiAgICAgIGNvbnN0IEdlbmVyYXRvciA9IHJlcXVpcmUoc3dDb25maWdQYXRoKS5HZW5lcmF0b3I7XG4gICAgICBjb25zdCBnZW4gPSBuZXcgR2VuZXJhdG9yKG5ldyBDbGlGaWxlc3lzdGVtKGhvc3QsIG91dHB1dFBhdGgpLCBiYXNlSHJlZik7XG5cbiAgICAgIHJldHVybiBnZW4ucHJvY2Vzcyhjb25maWdKc29uKTtcbiAgICB9KSxcblxuICAgIHN3aXRjaE1hcChvdXRwdXQgPT4ge1xuICAgICAgY29uc3QgbWFuaWZlc3QgPSBKU09OLnN0cmluZ2lmeShvdXRwdXQsIG51bGwsIDIpO1xuICAgICAgcmV0dXJuIGhvc3QucmVhZCh3b3JrZXJQYXRoKS5waXBlKFxuICAgICAgICBzd2l0Y2hNYXAod29ya2VyQ29kZSA9PiB7XG4gICAgICAgICAgcmV0dXJuIG1lcmdlKFxuICAgICAgICAgICAgaG9zdC53cml0ZShqb2luKGRpc3RQYXRoLCAnbmdzdy5qc29uJyksIHZpcnR1YWxGcy5zdHJpbmdUb0ZpbGVCdWZmZXIobWFuaWZlc3QpKSxcbiAgICAgICAgICAgIGhvc3Qud3JpdGUoam9pbihkaXN0UGF0aCwgJ25nc3ctd29ya2VyLmpzJyksIHdvcmtlckNvZGUpLFxuICAgICAgICAgICkgYXMgT2JzZXJ2YWJsZTx2b2lkPjtcbiAgICAgICAgfSksXG4gICAgICApO1xuICAgIH0pLFxuXG4gICAgc3dpdGNoTWFwKCgpID0+IGhvc3QuZXhpc3RzKHNhZmV0eVBhdGgpKSxcbiAgICAvLyBJZiBAYW5ndWxhci9zZXJ2aWNlLXdvcmtlciBoYXMgdGhlIHNhZmV0eSBzY3JpcHQsIGNvcHkgaXQgaW50byB0d28gbG9jYXRpb25zLlxuICAgIHN3aXRjaE1hcChleGlzdHMgPT4ge1xuICAgICAgaWYgKCFleGlzdHMpIHtcbiAgICAgICAgcmV0dXJuIG9mPHZvaWQ+KHVuZGVmaW5lZCk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBob3N0LnJlYWQoc2FmZXR5UGF0aCkucGlwZShcbiAgICAgICAgc3dpdGNoTWFwKHNhZmV0eUNvZGUgPT4ge1xuICAgICAgICAgIHJldHVybiBtZXJnZShcbiAgICAgICAgICAgIGhvc3Qud3JpdGUoam9pbihkaXN0UGF0aCwgJ3dvcmtlci1iYXNpYy5taW4uanMnKSwgc2FmZXR5Q29kZSksXG4gICAgICAgICAgICBob3N0LndyaXRlKGpvaW4oZGlzdFBhdGgsICdzYWZldHktd29ya2VyLmpzJyksIHNhZmV0eUNvZGUpLFxuICAgICAgICAgICkgYXMgT2JzZXJ2YWJsZTx2b2lkPjtcbiAgICAgICAgfSksXG4gICAgICApO1xuICAgIH0pLFxuXG4gICAgLy8gUmVtb3ZlIGFsbCBlbGVtZW50cywgcmVkdWNlIHRoZW0gdG8gYSBzaW5nbGUgZW1pdC5cbiAgICByZWR1Y2UoKCkgPT4ge30pLFxuICApLnRvUHJvbWlzZSgpO1xufVxuIl19