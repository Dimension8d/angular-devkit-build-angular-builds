"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * @license
 * Copyright Google Inc. All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
const index2_1 = require("@angular-devkit/architect/src/index2");
const core_1 = require("@angular-devkit/core");
const node_1 = require("@angular-devkit/core/node");
const path = require("path");
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const index2_2 = require("../../../build_webpack/src/webpack/index2");
const webpack_configs_1 = require("../angular-cli-files/models/webpack-configs");
const read_tsconfig_1 = require("../angular-cli-files/utilities/read-tsconfig");
const require_project_module_1 = require("../angular-cli-files/utilities/require-project-module");
const utils_1 = require("../utils");
const webpackMerge = require('webpack-merge');
exports.default = index2_1.createBuilder((options, context) => {
    const host = new core_1.virtualFs.AliasHost(new node_1.NodeJsSyncHost());
    const root = context.workspaceRoot;
    async function setup() {
        const registry = new core_1.schema.CoreSchemaRegistry();
        registry.addPostTransform(core_1.schema.transforms.addUndefinedDefaults);
        const workspace = await core_1.experimental.workspace.Workspace.fromPath(host, core_1.normalize(context.workspaceRoot), registry);
        const projectName = context.target ? context.target.project : workspace.getDefaultProjectName();
        if (!projectName) {
            throw new Error('Must either have a target from the context or a default project.');
        }
        const projectRoot = core_1.resolve(workspace.root, core_1.normalize(workspace.getProject(projectName).root));
        const workspaceSourceRoot = workspace.getProject(projectName).sourceRoot;
        const sourceRoot = workspaceSourceRoot !== undefined ? core_1.resolve(workspace.root, core_1.normalize(workspaceSourceRoot)) : undefined;
        const normalizedOptions = utils_1.normalizeWebpackServerSchema(host, core_1.normalize(root), projectRoot, sourceRoot, options);
        return { normalizedOptions, projectRoot };
    }
    return rxjs_1.from(setup()).pipe(operators_1.concatMap(v => {
        if (options.deleteOutputPath) {
            return utils_1.deleteOutputDir(core_1.normalize(root), core_1.normalize(options.outputPath), host).pipe(operators_1.map(() => v));
        }
        else {
            return rxjs_1.of(v);
        }
    }), operators_1.concatMap(({ normalizedOptions, projectRoot }) => {
        const webpackConfig = buildServerWebpackConfig(core_1.normalize(root), projectRoot, host, normalizedOptions, context.logger.createChild('webpack'));
        return index2_2.runWebpack(webpackConfig, context);
    }), operators_1.map(output => {
        if (output.success === false) {
            return output;
        }
        return Object.assign({}, output, { outputPath: path.resolve(root, options.outputPath) });
    }));
});
function buildServerWebpackConfig(root, projectRoot, _host, options, logger) {
    let wco;
    // TODO: make target defaults into configurations instead
    // options = this.addTargetDefaults(options);
    const tsConfigPath = core_1.getSystemPath(core_1.normalize(core_1.resolve(root, core_1.normalize(options.tsConfig))));
    const tsConfig = read_tsconfig_1.readTsconfig(tsConfigPath);
    const projectTs = require_project_module_1.requireProjectModule(core_1.getSystemPath(projectRoot), 'typescript');
    const supportES2015 = tsConfig.options.target !== projectTs.ScriptTarget.ES3
        && tsConfig.options.target !== projectTs.ScriptTarget.ES5;
    const buildOptions = Object.assign({}, options);
    wco = {
        root: core_1.getSystemPath(root),
        projectRoot: core_1.getSystemPath(projectRoot),
        // TODO: use only this.options, it contains all flags and configs items already.
        buildOptions: Object.assign({}, buildOptions, { buildOptimizer: false, aot: true, platform: 'server', scripts: [], styles: [] }),
        tsConfig,
        tsConfigPath,
        supportES2015,
        logger,
    };
    wco.buildOptions.progress = utils_1.defaultProgress(wco.buildOptions.progress);
    const webpackConfigs = [
        webpack_configs_1.getCommonConfig(wco),
        webpack_configs_1.getServerConfig(wco),
        webpack_configs_1.getStylesConfig(wco),
        webpack_configs_1.getStatsConfig(wco),
    ];
    if (wco.buildOptions.main || wco.buildOptions.polyfills) {
        const typescriptConfigPartial = wco.buildOptions.aot
            ? webpack_configs_1.getAotConfig(wco)
            : webpack_configs_1.getNonAotConfig(wco);
        webpackConfigs.push(typescriptConfigPartial);
    }
    return webpackMerge(webpackConfigs);
}
exports.buildServerWebpackConfig = buildServerWebpackConfig;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXgyLmpzIiwic291cmNlUm9vdCI6Ii4vIiwic291cmNlcyI6WyJwYWNrYWdlcy9hbmd1bGFyX2RldmtpdC9idWlsZF9hbmd1bGFyL3NyYy9zZXJ2ZXIvaW5kZXgyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUE7Ozs7OztHQU1HO0FBQ0gsaUVBQW9GO0FBQ3BGLCtDQVE4QjtBQUM5QixvREFBMkQ7QUFFM0QsNkJBQTZCO0FBQzdCLCtCQUFnQztBQUNoQyw4Q0FBZ0Q7QUFFaEQsc0VBQXVFO0FBRXZFLGlGQU9xRDtBQUNyRCxnRkFBNEU7QUFDNUUsa0dBQTZGO0FBQzdGLG9DQUlrQjtBQUVsQixNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUM7QUFTOUMsa0JBQWUsc0JBQWEsQ0FHMUIsQ0FBQyxPQUFPLEVBQUUsT0FBTyxFQUFFLEVBQUU7SUFDckIsTUFBTSxJQUFJLEdBQUcsSUFBSSxnQkFBUyxDQUFDLFNBQVMsQ0FBQyxJQUFJLHFCQUFjLEVBQUUsQ0FBQyxDQUFDO0lBQzNELE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUM7SUFFbkMsS0FBSyxVQUFVLEtBQUs7UUFDbEIsTUFBTSxRQUFRLEdBQUcsSUFBSSxhQUFNLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztRQUNqRCxRQUFRLENBQUMsZ0JBQWdCLENBQUMsYUFBTSxDQUFDLFVBQVUsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO1FBRWxFLE1BQU0sU0FBUyxHQUFHLE1BQU0sbUJBQVksQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FDL0QsSUFBSSxFQUNKLGdCQUFTLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxFQUNoQyxRQUFRLENBQ1QsQ0FBQztRQUNGLE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMscUJBQXFCLEVBQUUs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QUMsY0FBYyxDQUFDLENBQUM7QUFDdEMsQ0FBQztBQTNERCw0REEyREMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgR29vZ2xlIEluYy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxuICovXG5pbXBvcnQgeyBCdWlsZGVyT3V0cHV0LCBjcmVhdGVCdWlsZGVyIH0gZnJvbSAnQGFuZ3VsYXItZGV2a2l0L2FyY2hpdGVjdC9zcmMvaW5kZXgyJztcbmltcG9ydCB7XG4gIFBhdGgsXG4gIGV4cGVyaW1lbnRhbCxcbiAgZ2V0U3lzdGVtUGF0aCxcbiAganNvbixcbiAgbG9nZ2luZyxcbiAgbm9ybWFsaXplLFxuICByZXNvbHZlLCBzY2hlbWEsIHZpcnR1YWxGcyxcbn0gZnJvbSAnQGFuZ3VsYXItZGV2a2l0L2NvcmUnO1xuaW1wb3J0IHsgTm9kZUpzU3luY0hvc3QgfSBmcm9tICdAYW5ndWxhci1kZXZraXQvY29yZS9ub2RlJztcbmltcG9ydCB7IFN0YXRzIH0gZnJvbSAnZnMnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGZyb20sIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBjb25jYXRNYXAsIG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCAqIGFzIHRzIGZyb20gJ3R5cGVzY3JpcHQnOyAvLyB0c2xpbnQ6ZGlzYWJsZS1saW5lOm5vLWltcGxpY2l0LWRlcGVuZGVuY2llc1xuaW1wb3J0IHsgcnVuV2VicGFjayB9IGZyb20gJy4uLy4uLy4uL2J1aWxkX3dlYnBhY2svc3JjL3dlYnBhY2svaW5kZXgyJztcbmltcG9ydCB7IFdlYnBhY2tDb25maWdPcHRpb25zIH0gZnJvbSAnLi4vYW5ndWxhci1jbGktZmlsZXMvbW9kZWxzL2J1aWxkLW9wdGlvbnMnO1xuaW1wb3J0IHtcbiAgZ2V0QW90Q29uZmlnLFxuICBnZXRDb21tb25Db25maWcsXG4gIGdldE5vbkFvdENvbmZpZyxcbiAgZ2V0U2VydmVyQ29uZmlnLFxuICBnZXRTdGF0c0NvbmZpZyxcbiAgZ2V0U3R5bGVzQ29uZmlnLFxufSBmcm9tICcuLi9hbmd1bGFyLWNsaS1maWxlcy9tb2RlbHMvd2VicGFjay1jb25maWdzJztcbmltcG9ydCB7IHJlYWRUc2NvbmZpZyB9IGZyb20gJy4uL2FuZ3VsYXItY2xpLWZpbGVzL3V0aWxpdGllcy9yZWFkLXRzY29uZmlnJztcbmltcG9ydCB7IHJlcXVpcmVQcm9qZWN0TW9kdWxlIH0gZnJvbSAnLi4vYW5ndWxhci1jbGktZmlsZXMvdXRpbGl0aWVzL3JlcXVpcmUtcHJvamVjdC1tb2R1bGUnO1xuaW1wb3J0IHtcbiAgTm9ybWFsaXplZFdlYnBhY2tTZXJ2ZXJCdWlsZGVyU2NoZW1hLCBkZWZhdWx0UHJvZ3Jlc3MsXG4gIGRlbGV0ZU91dHB1dERpcixcbiAgbm9ybWFsaXplV2VicGFja1NlcnZlclNjaGVtYSxcbn0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IHsgU2NoZW1hIGFzIEJ1aWxkV2VicGFja1NlcnZlclNjaGVtYSB9IGZyb20gJy4vc2NoZW1hJztcbmNvbnN0IHdlYnBhY2tNZXJnZSA9IHJlcXVpcmUoJ3dlYnBhY2stbWVyZ2UnKTtcblxuXG4vLyBJZiBzdWNjZXNzIGlzIHRydWUsIG91dHB1dFBhdGggc2hvdWxkIGJlIHNldC5cbmV4cG9ydCB0eXBlIFNlcnZlckJ1aWxkZXJPdXRwdXQgPSBqc29uLkpzb25PYmplY3QgJiBCdWlsZGVyT3V0cHV0ICYge1xuICBvdXRwdXRQYXRoPzogc3RyaW5nO1xufTtcblxuXG5leHBvcnQgZGVmYXVsdCBjcmVhdGVCdWlsZGVyPFxuICBqc29uLkpzb25PYmplY3QgJiBCdWlsZFdlYnBhY2tTZXJ2ZXJTY2hlbWEsXG4gIFNlcnZlckJ1aWxkZXJPdXRwdXRcbj4oKG9wdGlvbnMsIGNvbnRleHQpID0+IHtcbiAgY29uc3QgaG9zdCA9IG5ldyB2aXJ0dWFsRnMuQWxpYXNIb3N0KG5ldyBOb2RlSnNTeW5jSG9zdCgpKTtcbiAgY29uc3Qgcm9vdCA9IGNvbnRleHQud29ya3NwYWNlUm9vdDtcblxuICBhc3luYyBmdW5jdGlvbiBzZXR1cCgpIHtcbiAgICBjb25zdCByZWdpc3RyeSA9IG5ldyBzY2hlbWEuQ29yZVNjaGVtYVJlZ2lzdHJ5KCk7XG4gICAgcmVnaXN0cnkuYWRkUG9zdFRyYW5zZm9ybShzY2hlbWEudHJhbnNmb3Jtcy5hZGRVbmRlZmluZWREZWZhdWx0cyk7XG5cbiAgICBjb25zdCB3b3Jrc3BhY2UgPSBhd2FpdCBleHBlcmltZW50YWwud29ya3NwYWNlLldvcmtzcGFjZS5mcm9tUGF0aChcbiAgICAgIGhvc3QsXG4gICAgICBub3JtYWxpemUoY29udGV4dC53b3Jrc3BhY2VSb290KSxcbiAgICAgIHJlZ2lzdHJ5LFxuICAgICk7XG4gICAgY29uc3QgcHJvamVjdE5hbWUgPSBjb250ZXh0LnRhcmdldCA/IGNvbnRleHQudGFyZ2V0LnByb2plY3QgOiB3b3Jrc3BhY2UuZ2V0RGVmYXVsdFByb2plY3ROYW1lKCk7XG5cbiAgICBpZiAoIXByb2plY3ROYW1lKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ011c3QgZWl0aGVyIGhhdmUgYSB0YXJnZXQgZnJvbSB0aGUgY29udGV4dCBvciBhIGRlZmF1bHQgcHJvamVjdC4nKTtcbiAgICB9XG4gICAgY29uc3QgcHJvamVjdFJvb3QgPSByZXNvbHZlKFxuICAgICAgd29ya3NwYWNlLnJvb3QsXG4gICAgICBub3JtYWxpemUod29ya3NwYWNlLmdldFByb2plY3QocHJvamVjdE5hbWUpLnJvb3QpLFxuICAgICk7XG4gICAgY29uc3Qgd29ya3NwYWNlU291cmNlUm9vdCA9IHdvcmtzcGFjZS5nZXRQcm9qZWN0KHByb2plY3ROYW1lKS5zb3VyY2VSb290O1xuICAgIGNvbnN0IHNvdXJjZVJvb3QgPSB3b3Jrc3BhY2VTb3VyY2VSb290ICE9PSB1bmRlZmluZWQgPyByZXNvbHZlKFxuICAgICAgd29ya3NwYWNlLnJvb3QsXG4gICAgICBub3JtYWxpemUod29ya3NwYWNlU291cmNlUm9vdCksXG4gICAgKSA6IHVuZGVmaW5lZDtcblxuICAgIGNvbnN0IG5vcm1hbGl6ZWRPcHRpb25zID0gbm9ybWFsaXplV2VicGFja1NlcnZlclNjaGVtYShcbiAgICAgIGhvc3QsXG4gICAgICBub3JtYWxpemUocm9vdCksXG4gICAgICBwcm9qZWN0Um9vdCxcbiAgICAgIHNvdXJjZVJvb3QsXG4gICAgICBvcHRpb25zLFxuICAgICk7XG5cbiAgICByZXR1cm4geyBub3JtYWxpemVkT3B0aW9ucywgcHJvamVjdFJvb3QgfTtcbiAgfVxuXG4gIHJldHVybiBmcm9tKHNldHVwKCkpLnBpcGUoXG4gICAgY29uY2F0TWFwKHYgPT4ge1xuICAgICAgaWYgKG9wdGlvbnMuZGVsZXRlT3V0cHV0UGF0aCkge1xuICAgICAgICByZXR1cm4gZGVsZXRlT3V0cHV0RGlyKG5vcm1hbGl6ZShyb290KSwgbm9ybWFsaXplKG9wdGlvbnMub3V0cHV0UGF0aCksIGhvc3QpLnBpcGUoXG4gICAgICAgICAgbWFwKCgpID0+IHYpLFxuICAgICAgICApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIG9mKHYpO1xuICAgICAgfVxuICAgIH0pLFxuICAgIGNvbmNhdE1hcCgoeyBub3JtYWxpemVkT3B0aW9ucywgcHJvamVjdFJvb3QgfSkgPT4ge1xuICAgICAgY29uc3Qgd2VicGFja0NvbmZpZyA9IGJ1aWxkU2VydmVyV2VicGFja0NvbmZpZyhcbiAgICAgICAgbm9ybWFsaXplKHJvb3QpLFxuICAgICAgICBwcm9qZWN0Um9vdCxcbiAgICAgICAgaG9zdCxcbiAgICAgICAgbm9ybWFsaXplZE9wdGlvbnMsXG4gICAgICAgIGNvbnRleHQubG9nZ2VyLmNyZWF0ZUNoaWxkKCd3ZWJwYWNrJyksXG4gICAgICApO1xuXG4gICAgICByZXR1cm4gcnVuV2VicGFjayh3ZWJwYWNrQ29uZmlnLCBjb250ZXh0KTtcbiAgICB9KSxcbiAgICBtYXAob3V0cHV0ID0+IHtcbiAgICAgIGlmIChvdXRwdXQuc3VjY2VzcyA9PT0gZmFsc2UpIHtcbiAgICAgICAgcmV0dXJuIG91dHB1dCBhcyBTZXJ2ZXJCdWlsZGVyT3V0cHV0O1xuICAgICAgfVxuXG4gICAgICByZXR1cm4ge1xuICAgICAgICAuLi5vdXRwdXQsXG4gICAgICAgIG91dHB1dFBhdGg6IHBhdGgucmVzb2x2ZShyb290LCBvcHRpb25zLm91dHB1dFBhdGgpLFxuICAgICAgfSBhcyBTZXJ2ZXJCdWlsZGVyT3V0cHV0O1xuICAgIH0pLFxuICApO1xufSk7XG5cbmV4cG9ydCBmdW5jdGlvbiBidWlsZFNlcnZlcldlYnBhY2tDb25maWcoXG4gIHJvb3Q6IFBhdGgsXG4gIHByb2plY3RSb290OiBQYXRoLFxuICBfaG9zdDogdmlydHVhbEZzLkhvc3Q8U3RhdHM+LFxuICBvcHRpb25zOiBOb3JtYWxpemVkV2VicGFja1NlcnZlckJ1aWxkZXJTY2hlbWEsXG4gIGxvZ2dlcjogbG9nZ2luZy5Mb2dnZXIsXG4pIHtcbiAgbGV0IHdjbzogV2VicGFja0NvbmZpZ09wdGlvbnM7XG5cbiAgLy8gVE9ETzogbWFrZSB0YXJnZXQgZGVmYXVsdHMgaW50byBjb25maWd1cmF0aW9ucyBpbnN0ZWFkXG4gIC8vIG9wdGlvbnMgPSB0aGlzLmFkZFRhcmdldERlZmF1bHRzKG9wdGlvbnMpO1xuXG4gIGNvbnN0IHRzQ29uZmlnUGF0aCA9IGdldFN5c3RlbVBhdGgobm9ybWFsaXplKHJlc29sdmUocm9vdCwgbm9ybWFsaXplKG9wdGlvbnMudHNDb25maWcpKSkpO1xuICBjb25zdCB0c0NvbmZpZyA9IHJlYWRUc2NvbmZpZyh0c0NvbmZpZ1BhdGgpO1xuXG4gIGNvbnN0IHByb2plY3RUcyA9IHJlcXVpcmVQcm9qZWN0TW9kdWxlKGdldFN5c3RlbVBhdGgocHJvamVjdFJvb3QpLCAndHlwZXNjcmlwdCcpIGFzIHR5cGVvZiB0cztcblxuICBjb25zdCBzdXBwb3J0RVMyMDE1ID0gdHNDb25maWcub3B0aW9ucy50YXJnZXQgIT09IHByb2plY3RUcy5TY3JpcHRUYXJnZXQuRVMzXG4gICAgJiYgdHNDb25maWcub3B0aW9ucy50YXJnZXQgIT09IHByb2plY3RUcy5TY3JpcHRUYXJnZXQuRVM1O1xuXG4gIGNvbnN0IGJ1aWxkT3B0aW9uczogdHlwZW9mIHdjb1snYnVpbGRPcHRpb25zJ10gPSB7XG4gICAgLi4ub3B0aW9ucyBhcyB7fSBhcyB0eXBlb2Ygd2NvWydidWlsZE9wdGlvbnMnXSxcbiAgfTtcblxuICB3Y28gPSB7XG4gICAgcm9vdDogZ2V0U3lzdGVtUGF0aChyb290KSxcbiAgICBwcm9qZWN0Um9vdDogZ2V0U3lzdGVtUGF0aChwcm9qZWN0Um9vdCksXG4gICAgLy8gVE9ETzogdXNlIG9ubHkgdGhpcy5vcHRpb25zLCBpdCBjb250YWlucyBhbGwgZmxhZ3MgYW5kIGNvbmZpZ3MgaXRlbXMgYWxyZWFkeS5cbiAgICBidWlsZE9wdGlvbnM6IHtcbiAgICAgIC4uLmJ1aWxkT3B0aW9ucyxcbiAgICAgIGJ1aWxkT3B0aW1pemVyOiBmYWxzZSxcbiAgICAgIGFvdDogdHJ1ZSxcbiAgICAgIHBsYXRmb3JtOiAnc2VydmVyJyxcbiAgICAgIHNjcmlwdHM6IFtdLFxuICAgICAgc3R5bGVzOiBbXSxcbiAgICB9LFxuICAgIHRzQ29uZmlnLFxuICAgIHRzQ29uZmlnUGF0aCxcbiAgICBzdXBwb3J0RVMyMDE1LFxuICAgIGxvZ2dlcixcbiAgfTtcblxuICB3Y28uYnVpbGRPcHRpb25zLnByb2dyZXNzID0gZGVmYXVsdFByb2dyZXNzKHdjby5idWlsZE9wdGlvbnMucHJvZ3Jlc3MpO1xuXG4gIGNvbnN0IHdlYnBhY2tDb25maWdzOiB7fVtdID0gW1xuICAgIGdldENvbW1vbkNvbmZpZyh3Y28pLFxuICAgIGdldFNlcnZlckNvbmZpZyh3Y28pLFxuICAgIGdldFN0eWxlc0NvbmZpZyh3Y28pLFxuICAgIGdldFN0YXRzQ29uZmlnKHdjbyksXG4gIF07XG5cbiAgaWYgKHdjby5idWlsZE9wdGlvbnMubWFpbiB8fCB3Y28uYnVpbGRPcHRpb25zLnBvbHlmaWxscykge1xuICAgIGNvbnN0IHR5cGVzY3JpcHRDb25maWdQYXJ0aWFsID0gd2NvLmJ1aWxkT3B0aW9ucy5hb3RcbiAgICAgID8gZ2V0QW90Q29uZmlnKHdjbylcbiAgICAgIDogZ2V0Tm9uQW90Q29uZmlnKHdjbyk7XG4gICAgd2VicGFja0NvbmZpZ3MucHVzaCh0eXBlc2NyaXB0Q29uZmlnUGFydGlhbCk7XG4gIH1cblxuICByZXR1cm4gd2VicGFja01lcmdlKHdlYnBhY2tDb25maWdzKTtcbn1cbiJdfQ==