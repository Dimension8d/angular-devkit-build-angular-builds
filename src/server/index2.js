"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * @license
 * Copyright Google Inc. All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
const index2_1 = require("@angular-devkit/architect/src/index2");
const core_1 = require("@angular-devkit/core");
const node_1 = require("@angular-devkit/core/node");
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const index2_2 = require("../../../build_webpack/src/webpack/index2");
const webpack_configs_1 = require("../angular-cli-files/models/webpack-configs");
const read_tsconfig_1 = require("../angular-cli-files/utilities/read-tsconfig");
const require_project_module_1 = require("../angular-cli-files/utilities/require-project-module");
const utils_1 = require("../utils");
const webpackMerge = require('webpack-merge');
exports.default = index2_1.createBuilder((options, context) => {
    const host = new core_1.virtualFs.AliasHost(new node_1.NodeJsSyncHost());
    const root = context.workspaceRoot;
    async function setup() {
        const registry = new core_1.schema.CoreSchemaRegistry();
        registry.addPostTransform(core_1.schema.transforms.addUndefinedDefaults);
        const workspace = await core_1.experimental.workspace.Workspace.fromPath(host, core_1.normalize(context.workspaceRoot), registry);
        const projectName = context.target ? context.target.project : workspace.getDefaultProjectName();
        if (!projectName) {
            throw new Error('Must either have a target from the context or a default project.');
        }
        const projectRoot = core_1.resolve(workspace.root, core_1.normalize(workspace.getProject(projectName).root));
        const workspaceSourceRoot = workspace.getProject(projectName).sourceRoot;
        const sourceRoot = workspaceSourceRoot !== undefined ? core_1.resolve(workspace.root, core_1.normalize(workspaceSourceRoot)) : undefined;
        const normalizedOptions = utils_1.normalizeWebpackServerSchema(host, core_1.normalize(root), projectRoot, sourceRoot, options);
        return { normalizedOptions, projectRoot };
    }
    return rxjs_1.from(setup()).pipe(operators_1.concatMap(v => {
        if (options.deleteOutputPath) {
            return utils_1.deleteOutputDir(core_1.normalize(root), core_1.normalize(options.outputPath), host).pipe(operators_1.map(() => v));
        }
        else {
            return rxjs_1.of(v);
        }
    }), operators_1.concatMap(({ normalizedOptions, projectRoot }) => {
        const webpackConfig = buildServerWebpackConfig(core_1.normalize(root), projectRoot, host, normalizedOptions, context.logger.createChild('webpack'));
        return index2_2.runWebpack(webpackConfig, context);
    }));
});
function buildServerWebpackConfig(root, projectRoot, _host, options, logger) {
    let wco;
    // TODO: make target defaults into configurations instead
    // options = this.addTargetDefaults(options);
    const tsConfigPath = core_1.getSystemPath(core_1.normalize(core_1.resolve(root, core_1.normalize(options.tsConfig))));
    const tsConfig = read_tsconfig_1.readTsconfig(tsConfigPath);
    const projectTs = require_project_module_1.requireProjectModule(core_1.getSystemPath(projectRoot), 'typescript');
    const supportES2015 = tsConfig.options.target !== projectTs.ScriptTarget.ES3
        && tsConfig.options.target !== projectTs.ScriptTarget.ES5;
    const buildOptions = Object.assign({}, options);
    wco = {
        root: core_1.getSystemPath(root),
        projectRoot: core_1.getSystemPath(projectRoot),
        // TODO: use only this.options, it contains all flags and configs items already.
        buildOptions: Object.assign({}, buildOptions, { buildOptimizer: false, aot: true, platform: 'server', scripts: [], styles: [] }),
        tsConfig,
        tsConfigPath,
        supportES2015,
        logger,
    };
    wco.buildOptions.progress = utils_1.defaultProgress(wco.buildOptions.progress);
    const webpackConfigs = [
        webpack_configs_1.getCommonConfig(wco),
        webpack_configs_1.getServerConfig(wco),
        webpack_configs_1.getStylesConfig(wco),
        webpack_configs_1.getStatsConfig(wco),
    ];
    if (wco.buildOptions.main || wco.buildOptions.polyfills) {
        const typescriptConfigPartial = wco.buildOptions.aot
            ? webpack_configs_1.getAotConfig(wco)
            : webpack_configs_1.getNonAotConfig(wco);
        webpackConfigs.push(typescriptConfigPartial);
    }
    return webpackMerge(webpackConfigs);
}
exports.buildServerWebpackConfig = buildServerWebpackConfig;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXgyLmpzIiwic291cmNlUm9vdCI6Ii4vIiwic291cmNlcyI6WyJwYWNrYWdlcy9hbmd1bGFyX2RldmtpdC9idWlsZF9hbmd1bGFyL3NyYy9zZXJ2ZXIvaW5kZXgyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUE7Ozs7OztHQU1HO0FBQ0gsaUVBQXFFO0FBQ3JFLCtDQVE4QjtBQUM5QixvREFBMkQ7QUFFM0QsK0JBQWdDO0FBQ2hDLDhDQUFnRDtBQUVoRCxzRUFBdUU7QUFFdkUsaUZBT3FEO0FBQ3JELGdGQUE0RTtBQUM1RSxrR0FBNkY7QUFDN0Ysb0NBSWtCO0FBRWxCLE1BQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQztBQUc5QyxrQkFBZSxzQkFBYSxDQUE2QyxDQUFDLE9BQU8sRUFBRSxPQUFPLEVBQUUsRUFBRTtJQUM1RixNQUFNLElBQUksR0FBRyxJQUFJLGdCQUFTLENBQUMsU0FBUyxDQUFDLElBQUkscUJBQWMsRUFBRSxDQUFDLENBQUM7SUFDM0QsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQztJQUVuQyxLQUFLLFVBQVUsS0FBSztRQUNsQixNQUFNLFFBQVEsR0FBRyxJQUFJLGFBQU0sQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1FBQ2pELFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxhQUFNLENBQUMsVUFBVSxDQUFDLG9CQUFvQixDQUFDLENBQUM7UUFFbEUsTUFBTSxTQUFTLEdBQUcsTUFBTSxtQkFBWSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUMvRCxJQUFJLEVBQ0osZ0JBQVMsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLEVBQ2hDLFFBQVEsQ0FDVCxDQUFDO1FBQ0YsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1FBRWhHLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDaEIsTUFBTSxJQUFJLEtBQUssQ0FBQyxrRUFBa0UsQ0FBQyxDQUFDO1NBQ3JGO1FBQ0QsTUFBTSxXQUFXLEdBQUcsY0FBTyxDQUN6QixTQUFTLENBQUMsSUFBSSxFQUNkLGdCQUFTLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FDbEQsQ0FBQztRQUNGLE1BQU0sbUJBQW1CLEdBQUcsU0FBUyxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsQ0FBQyxVQUFVLENBQUM7UUFDekUsTUFBTSxVQUFVLEdBQUcsbUJBQW1CLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxjQUFPLENBQzVELFNBQVMsQ0FBQyxJQUFJLEVBQ2QsZ0JBQVMsQ0FBQyxtQkFBbUIsQ0FBQyxDQUMvQixDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7UUFFZCxNQUFNLGlCQUFpQixHQUFHLG9DQUE0QixDQUNwRCxJQUFJLEVBQ0osZ0JBQVMsQ0FBQyxJQUFJLENBQUMsRUFDZixXQUFXLEVBQ1gsVUFBVSxFQUNWLE9BQU8sQ0FDUixDQUFDO1FBRUYsT0FBTyxFQUFFLGlCQUFpQixFQUFFLFdBQVcsRUFBRSxDQUFDO0lBQzVDLENBQUM7SUFFRCxPQUFPLFdBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FDdkIscUJBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRTtRQUNaLElBQUksT0FBTyxDQUFDLGdCQUFnQixFQUFFO1lBQzVCLE9BQU8sdUJBQWUsQ0FBQyxnQkFBUyxDQUFDLElBQUksQ0FBQyxFQUFFLGdCQUFTLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLElBQUksQ0FDL0UsZUFBRyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUNiLENBQUM7U0FDSDthQUFNO1lBQ0wsT0FBTyxTQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDZDtJQUNILENBQUMsQ0FBQyxFQUNGLHFCQUFTLENBQUMsQ0FBQyxFQUFFLGlCQUFpQixFQUFFLFdBQVcsRUFBRSxFQUFFLEVBQUU7UUFDL0MsTUFBTSxhQUFhLEdBQUcsd0JBQXdCLENBQzVDLGdCQUFTLENBQUMsSUFBSSxDQUFDLEVBQ2YsV0FBVyxFQUNYLElBQUksRUFDSixpQkFBaUIsRUFDakIsT0FBTyxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQ3RDLENBQUM7UUFFRixPQUFPLG1CQUFVLENBQUMsYUFBYSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQzVDLENBQUMsQ0FBQyxDQUNILENBQUM7QUFDSixDQUFDLENBQUMsQ0FBQztBQUVILFNBQWdCLHdCQUF3QixDQUN0QyxJQUFVLEVBQ1YsV0FBaUIsRUFDakIsS0FBNEIsRUFDNUIsT0FBNkMsRUFDN0MsTUFBc0I7SUFFdEIsSUFBSSxHQUF5QixDQUFDO0lBRTlCLHlEQUF5RDtJQUN6RCw2Q0FBNkM7SUFFN0MsTUFBTSxZQUFZLEdBQUcsb0JBQWEsQ0FBQyxnQkFBUyxDQUFDLGNBQU8sQ0FBQyxJQUFJLEVBQUUsZ0JBQVMsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDMUYsTUFBTSxRQUFRLEdBQUcsNEJBQVksQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUU1QyxNQUFNLFNBQVMsR0FBRyw2Q0FBb0IsQ0FBQyxvQkFBYSxDQUFDLFdBQVcsQ0FBQyxFQUFFLFlBQVksQ0FBYyxDQUFDO0lBRTlGLE1BQU0sYUFBYSxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsTUFBTSxLQUFLLFNBQVMsQ0FBQyxZQUFZLENBQUMsR0FBRztXQUN2RSxRQUFRLENBQUMsT0FBTyxDQUFDLE1BQU0sS0FBSyxTQUFTLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQztJQUU1RCxNQUFNLFlBQVkscUJBQ2IsT0FBMkMsQ0FDL0MsQ0FBQztJQUVGLEdBQUcsR0FBRztRQUNKLElBQUksRUFBRSxvQkFBYSxDQUFDLElBQUksQ0FBQztRQUN6QixXQUFXLEVBQUUsb0JBQWEsQ0FBQyxXQUFXLENBQUM7UUFDdkMsZ0ZBQWdGO1FBQ2hGLFlBQVksb0JBQ1AsWUFBWSxJQUNmLGNBQWMsRUFBRSxLQUFLLEVBQ3JCLEdBQUcsRUFBRSxJQUFJLEVBQ1QsUUFBUSxFQUFFLFFBQVEsRUFDbEIsT0FBTyxFQUFFLEVBQUUsRUFDWCxNQUFNLEVBQUUsRUFBRSxHQUNYO1FBQ0QsUUFBUTtRQUNSLFlBQVk7UUFDWixhQUFhO1FBQ2IsTUFBTTtLQUNQLENBQUM7SUFFRixHQUFHLENBQUMsWUFBWSxDQUFDLFFBQVEsR0FBRyx1QkFBZSxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUM7SUFFdkUsTUFBTSxjQUFjLEdBQVM7UUFDM0IsaUNBQWUsQ0FBQyxHQUFHLENBQUM7UUFDcEIsaUNBQWUsQ0FBQyxHQUFHLENBQUM7UUFDcEIsaUNBQWUsQ0FBQyxHQUFHLENBQUM7UUFDcEIsZ0NBQWMsQ0FBQyxHQUFHLENBQUM7S0FDcEIsQ0FBQztJQUVGLElBQUksR0FBRyxDQUFDLFlBQVksQ0FBQyxJQUFJLElBQUksR0FBRyxDQUFDLFlBQVksQ0FBQyxTQUFTLEVBQUU7UUFDdkQsTUFBTSx1QkFBdUIsR0FBRyxHQUFHLENBQUMsWUFBWSxDQUFDLEdBQUc7WUFDbEQsQ0FBQyxDQUFDLDhCQUFZLENBQUMsR0FBRyxDQUFDO1lBQ25CLENBQUMsQ0FBQyxpQ0FBZSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3pCLGNBQWMsQ0FBQyxJQUFJLENBQUMsdUJBQXVCLENBQUMsQ0FBQztLQUM5QztJQUVELE9BQU8sWUFBWSxDQUFDLGNBQWMsQ0FBQyxDQUFDO0FBQ3RDLENBQUM7QUEzREQsNERBMkRDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEdvb2dsZSBJbmMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmlvL2xpY2Vuc2VcbiAqL1xuaW1wb3J0IHsgY3JlYXRlQnVpbGRlciB9IGZyb20gJ0Bhbmd1bGFyLWRldmtpdC9hcmNoaXRlY3Qvc3JjL2luZGV4Mic7XG5pbXBvcnQge1xuICBQYXRoLFxuICBleHBlcmltZW50YWwsXG4gIGdldFN5c3RlbVBhdGgsXG4gIGpzb24sXG4gIGxvZ2dpbmcsXG4gIG5vcm1hbGl6ZSxcbiAgcmVzb2x2ZSwgc2NoZW1hLCB2aXJ0dWFsRnMsXG59IGZyb20gJ0Bhbmd1bGFyLWRldmtpdC9jb3JlJztcbmltcG9ydCB7IE5vZGVKc1N5bmNIb3N0IH0gZnJvbSAnQGFuZ3VsYXItZGV2a2l0L2NvcmUvbm9kZSc7XG5pbXBvcnQgeyBTdGF0cyB9IGZyb20gJ2ZzJztcbmltcG9ydCB7IGZyb20sIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBjb25jYXRNYXAsIG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCAqIGFzIHRzIGZyb20gJ3R5cGVzY3JpcHQnOyAvLyB0c2xpbnQ6ZGlzYWJsZS1saW5lOm5vLWltcGxpY2l0LWRlcGVuZGVuY2llc1xuaW1wb3J0IHsgcnVuV2VicGFjayB9IGZyb20gJy4uLy4uLy4uL2J1aWxkX3dlYnBhY2svc3JjL3dlYnBhY2svaW5kZXgyJztcbmltcG9ydCB7IFdlYnBhY2tDb25maWdPcHRpb25zIH0gZnJvbSAnLi4vYW5ndWxhci1jbGktZmlsZXMvbW9kZWxzL2J1aWxkLW9wdGlvbnMnO1xuaW1wb3J0IHtcbiAgZ2V0QW90Q29uZmlnLFxuICBnZXRDb21tb25Db25maWcsXG4gIGdldE5vbkFvdENvbmZpZyxcbiAgZ2V0U2VydmVyQ29uZmlnLFxuICBnZXRTdGF0c0NvbmZpZyxcbiAgZ2V0U3R5bGVzQ29uZmlnLFxufSBmcm9tICcuLi9hbmd1bGFyLWNsaS1maWxlcy9tb2RlbHMvd2VicGFjay1jb25maWdzJztcbmltcG9ydCB7IHJlYWRUc2NvbmZpZyB9IGZyb20gJy4uL2FuZ3VsYXItY2xpLWZpbGVzL3V0aWxpdGllcy9yZWFkLXRzY29uZmlnJztcbmltcG9ydCB7IHJlcXVpcmVQcm9qZWN0TW9kdWxlIH0gZnJvbSAnLi4vYW5ndWxhci1jbGktZmlsZXMvdXRpbGl0aWVzL3JlcXVpcmUtcHJvamVjdC1tb2R1bGUnO1xuaW1wb3J0IHtcbiAgTm9ybWFsaXplZFdlYnBhY2tTZXJ2ZXJCdWlsZGVyU2NoZW1hLCBkZWZhdWx0UHJvZ3Jlc3MsXG4gIGRlbGV0ZU91dHB1dERpcixcbiAgbm9ybWFsaXplV2VicGFja1NlcnZlclNjaGVtYSxcbn0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IHsgU2NoZW1hIGFzIEJ1aWxkV2VicGFja1NlcnZlclNjaGVtYSB9IGZyb20gJy4vc2NoZW1hJztcbmNvbnN0IHdlYnBhY2tNZXJnZSA9IHJlcXVpcmUoJ3dlYnBhY2stbWVyZ2UnKTtcblxuXG5leHBvcnQgZGVmYXVsdCBjcmVhdGVCdWlsZGVyPGpzb24uSnNvbk9iamVjdCAmIEJ1aWxkV2VicGFja1NlcnZlclNjaGVtYT4oKG9wdGlvbnMsIGNvbnRleHQpID0+IHtcbiAgY29uc3QgaG9zdCA9IG5ldyB2aXJ0dWFsRnMuQWxpYXNIb3N0KG5ldyBOb2RlSnNTeW5jSG9zdCgpKTtcbiAgY29uc3Qgcm9vdCA9IGNvbnRleHQud29ya3NwYWNlUm9vdDtcblxuICBhc3luYyBmdW5jdGlvbiBzZXR1cCgpIHtcbiAgICBjb25zdCByZWdpc3RyeSA9IG5ldyBzY2hlbWEuQ29yZVNjaGVtYVJlZ2lzdHJ5KCk7XG4gICAgcmVnaXN0cnkuYWRkUG9zdFRyYW5zZm9ybShzY2hlbWEudHJhbnNmb3Jtcy5hZGRVbmRlZmluZWREZWZhdWx0cyk7XG5cbiAgICBjb25zdCB3b3Jrc3BhY2UgPSBhd2FpdCBleHBlcmltZW50YWwud29ya3NwYWNlLldvcmtzcGFjZS5mcm9tUGF0aChcbiAgICAgIGhvc3QsXG4gICAgICBub3JtYWxpemUoY29udGV4dC53b3Jrc3BhY2VSb290KSxcbiAgICAgIHJlZ2lzdHJ5LFxuICAgICk7XG4gICAgY29uc3QgcHJvamVjdE5hbWUgPSBjb250ZXh0LnRhcmdldCA/IGNvbnRleHQudGFyZ2V0LnByb2plY3QgOiB3b3Jrc3BhY2UuZ2V0RGVmYXVsdFByb2plY3ROYW1lKCk7XG5cbiAgICBpZiAoIXByb2plY3ROYW1lKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ011c3QgZWl0aGVyIGhhdmUgYSB0YXJnZXQgZnJvbSB0aGUgY29udGV4dCBvciBhIGRlZmF1bHQgcHJvamVjdC4nKTtcbiAgICB9XG4gICAgY29uc3QgcHJvamVjdFJvb3QgPSByZXNvbHZlKFxuICAgICAgd29ya3NwYWNlLnJvb3QsXG4gICAgICBub3JtYWxpemUod29ya3NwYWNlLmdldFByb2plY3QocHJvamVjdE5hbWUpLnJvb3QpLFxuICAgICk7XG4gICAgY29uc3Qgd29ya3NwYWNlU291cmNlUm9vdCA9IHdvcmtzcGFjZS5nZXRQcm9qZWN0KHByb2plY3ROYW1lKS5zb3VyY2VSb290O1xuICAgIGNvbnN0IHNvdXJjZVJvb3QgPSB3b3Jrc3BhY2VTb3VyY2VSb290ICE9PSB1bmRlZmluZWQgPyByZXNvbHZlKFxuICAgICAgd29ya3NwYWNlLnJvb3QsXG4gICAgICBub3JtYWxpemUod29ya3NwYWNlU291cmNlUm9vdCksXG4gICAgKSA6IHVuZGVmaW5lZDtcblxuICAgIGNvbnN0IG5vcm1hbGl6ZWRPcHRpb25zID0gbm9ybWFsaXplV2VicGFja1NlcnZlclNjaGVtYShcbiAgICAgIGhvc3QsXG4gICAgICBub3JtYWxpemUocm9vdCksXG4gICAgICBwcm9qZWN0Um9vdCxcbiAgICAgIHNvdXJjZVJvb3QsXG4gICAgICBvcHRpb25zLFxuICAgICk7XG5cbiAgICByZXR1cm4geyBub3JtYWxpemVkT3B0aW9ucywgcHJvamVjdFJvb3QgfTtcbiAgfVxuXG4gIHJldHVybiBmcm9tKHNldHVwKCkpLnBpcGUoXG4gICAgY29uY2F0TWFwKHYgPT4ge1xuICAgICAgaWYgKG9wdGlvbnMuZGVsZXRlT3V0cHV0UGF0aCkge1xuICAgICAgICByZXR1cm4gZGVsZXRlT3V0cHV0RGlyKG5vcm1hbGl6ZShyb290KSwgbm9ybWFsaXplKG9wdGlvbnMub3V0cHV0UGF0aCksIGhvc3QpLnBpcGUoXG4gICAgICAgICAgbWFwKCgpID0+IHYpLFxuICAgICAgICApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIG9mKHYpO1xuICAgICAgfVxuICAgIH0pLFxuICAgIGNvbmNhdE1hcCgoeyBub3JtYWxpemVkT3B0aW9ucywgcHJvamVjdFJvb3QgfSkgPT4ge1xuICAgICAgY29uc3Qgd2VicGFja0NvbmZpZyA9IGJ1aWxkU2VydmVyV2VicGFja0NvbmZpZyhcbiAgICAgICAgbm9ybWFsaXplKHJvb3QpLFxuICAgICAgICBwcm9qZWN0Um9vdCxcbiAgICAgICAgaG9zdCxcbiAgICAgICAgbm9ybWFsaXplZE9wdGlvbnMsXG4gICAgICAgIGNvbnRleHQubG9nZ2VyLmNyZWF0ZUNoaWxkKCd3ZWJwYWNrJyksXG4gICAgICApO1xuXG4gICAgICByZXR1cm4gcnVuV2VicGFjayh3ZWJwYWNrQ29uZmlnLCBjb250ZXh0KTtcbiAgICB9KSxcbiAgKTtcbn0pO1xuXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRTZXJ2ZXJXZWJwYWNrQ29uZmlnKFxuICByb290OiBQYXRoLFxuICBwcm9qZWN0Um9vdDogUGF0aCxcbiAgX2hvc3Q6IHZpcnR1YWxGcy5Ib3N0PFN0YXRzPixcbiAgb3B0aW9uczogTm9ybWFsaXplZFdlYnBhY2tTZXJ2ZXJCdWlsZGVyU2NoZW1hLFxuICBsb2dnZXI6IGxvZ2dpbmcuTG9nZ2VyLFxuKSB7XG4gIGxldCB3Y286IFdlYnBhY2tDb25maWdPcHRpb25zO1xuXG4gIC8vIFRPRE86IG1ha2UgdGFyZ2V0IGRlZmF1bHRzIGludG8gY29uZmlndXJhdGlvbnMgaW5zdGVhZFxuICAvLyBvcHRpb25zID0gdGhpcy5hZGRUYXJnZXREZWZhdWx0cyhvcHRpb25zKTtcblxuICBjb25zdCB0c0NvbmZpZ1BhdGggPSBnZXRTeXN0ZW1QYXRoKG5vcm1hbGl6ZShyZXNvbHZlKHJvb3QsIG5vcm1hbGl6ZShvcHRpb25zLnRzQ29uZmlnKSkpKTtcbiAgY29uc3QgdHNDb25maWcgPSByZWFkVHNjb25maWcodHNDb25maWdQYXRoKTtcblxuICBjb25zdCBwcm9qZWN0VHMgPSByZXF1aXJlUHJvamVjdE1vZHVsZShnZXRTeXN0ZW1QYXRoKHByb2plY3RSb290KSwgJ3R5cGVzY3JpcHQnKSBhcyB0eXBlb2YgdHM7XG5cbiAgY29uc3Qgc3VwcG9ydEVTMjAxNSA9IHRzQ29uZmlnLm9wdGlvbnMudGFyZ2V0ICE9PSBwcm9qZWN0VHMuU2NyaXB0VGFyZ2V0LkVTM1xuICAgICYmIHRzQ29uZmlnLm9wdGlvbnMudGFyZ2V0ICE9PSBwcm9qZWN0VHMuU2NyaXB0VGFyZ2V0LkVTNTtcblxuICBjb25zdCBidWlsZE9wdGlvbnM6IHR5cGVvZiB3Y29bJ2J1aWxkT3B0aW9ucyddID0ge1xuICAgIC4uLm9wdGlvbnMgYXMge30gYXMgdHlwZW9mIHdjb1snYnVpbGRPcHRpb25zJ10sXG4gIH07XG5cbiAgd2NvID0ge1xuICAgIHJvb3Q6IGdldFN5c3RlbVBhdGgocm9vdCksXG4gICAgcHJvamVjdFJvb3Q6IGdldFN5c3RlbVBhdGgocHJvamVjdFJvb3QpLFxuICAgIC8vIFRPRE86IHVzZSBvbmx5IHRoaXMub3B0aW9ucywgaXQgY29udGFpbnMgYWxsIGZsYWdzIGFuZCBjb25maWdzIGl0ZW1zIGFscmVhZHkuXG4gICAgYnVpbGRPcHRpb25zOiB7XG4gICAgICAuLi5idWlsZE9wdGlvbnMsXG4gICAgICBidWlsZE9wdGltaXplcjogZmFsc2UsXG4gICAgICBhb3Q6IHRydWUsXG4gICAgICBwbGF0Zm9ybTogJ3NlcnZlcicsXG4gICAgICBzY3JpcHRzOiBbXSxcbiAgICAgIHN0eWxlczogW10sXG4gICAgfSxcbiAgICB0c0NvbmZpZyxcbiAgICB0c0NvbmZpZ1BhdGgsXG4gICAgc3VwcG9ydEVTMjAxNSxcbiAgICBsb2dnZXIsXG4gIH07XG5cbiAgd2NvLmJ1aWxkT3B0aW9ucy5wcm9ncmVzcyA9IGRlZmF1bHRQcm9ncmVzcyh3Y28uYnVpbGRPcHRpb25zLnByb2dyZXNzKTtcblxuICBjb25zdCB3ZWJwYWNrQ29uZmlnczoge31bXSA9IFtcbiAgICBnZXRDb21tb25Db25maWcod2NvKSxcbiAgICBnZXRTZXJ2ZXJDb25maWcod2NvKSxcbiAgICBnZXRTdHlsZXNDb25maWcod2NvKSxcbiAgICBnZXRTdGF0c0NvbmZpZyh3Y28pLFxuICBdO1xuXG4gIGlmICh3Y28uYnVpbGRPcHRpb25zLm1haW4gfHwgd2NvLmJ1aWxkT3B0aW9ucy5wb2x5ZmlsbHMpIHtcbiAgICBjb25zdCB0eXBlc2NyaXB0Q29uZmlnUGFydGlhbCA9IHdjby5idWlsZE9wdGlvbnMuYW90XG4gICAgICA/IGdldEFvdENvbmZpZyh3Y28pXG4gICAgICA6IGdldE5vbkFvdENvbmZpZyh3Y28pO1xuICAgIHdlYnBhY2tDb25maWdzLnB1c2godHlwZXNjcmlwdENvbmZpZ1BhcnRpYWwpO1xuICB9XG5cbiAgcmV0dXJuIHdlYnBhY2tNZXJnZSh3ZWJwYWNrQ29uZmlncyk7XG59XG4iXX0=